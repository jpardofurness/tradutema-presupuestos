<!--
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                                                                  ‚ïë
‚ïë   TRADUTEMA QUOTES - GESTOR DE PRESUPUESTOS                     ‚ïë
‚ïë                                                                  ‚ïë
‚ïë   VERSI√ìN: 2.8.0                                                ‚ïë
‚ïë   FECHA:   30/12/2025 - 12:30                                   ‚ïë
‚ïë                                                                  ‚ïë
‚ïë   CAMBIOS EN ESTA VERSI√ìN:                                      ‚ïë
‚ïë   - Paso 4 redise√±ado: "Solo P√°ginas" (r√°pido) vs "Palabras"    ‚ïë
‚ïë   - Muestra tarifa por p√°gina de la combinaci√≥n actual          ‚ïë
‚ïë   - Fix: Mensaje de carga se oculta correctamente               ‚ïë
‚ïë   - Compresi√≥n PDFs con iLovePDF antes de subir                 ‚ïë
‚ïë   - Filtro por c√≥digo en Retomar presupuesto                    ‚ïë
‚ïë                                                                  ‚ïë
‚ïë   ARCHIVO: index.html (subir a GitHub Pages)                    ‚ïë
‚ïë                                                                  ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Tradutema QUOTES</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%233498db'/><text x='50' y='65' font-size='45' font-weight='bold' text-anchor='middle' fill='white'>TT</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --tradutema-blue: #3498db;
            --tradutema-blue-dark: #2980b9;
            --tradutema-gray: #5d6d7e;
            --accent-gold: #d4a853;
            --accent-green: #2ecc71;
            --accent-red: #e74c3c;
            --accent-orange: #f39c12;
            --bg-primary: #f8f9fa;
            --bg-card: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e5e7eb;
            --shadow-md: 0 4px 12px rgba(52,152,219,0.15);
            --shadow-lg: 0 10px 30px rgba(52,152,219,0.2);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'DM Sans', sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; line-height: 1.5; }
        
        /* HEADER */
        .header { background: var(--tradutema-blue); color: white; padding: 16px 20px; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-lg); }
        .header-content { max-width: 700px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-family: 'Space Mono', monospace; font-size: 1.2rem; font-weight: 700; display: flex; align-items: center; gap: 10px; letter-spacing: 2px; }
        .logo-icon-svg { flex-shrink: 0; }
        .logo-text { color: white; }
        .budget-id { font-family: 'Space Mono', monospace; font-size: 0.85rem; background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: var(--radius-sm); }
        .budget-id.active { background: white; color: var(--tradutema-blue); }
        .home-link { background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 12px; border-radius: var(--radius-sm); font-family: inherit; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px; }
        .home-link:hover { background: rgba(255,255,255,0.3); }
        
        /* PROGRESS STEPS */
        .progress-container { background: white; border-bottom: 1px solid var(--border-color); padding: 12px 20px; position: sticky; top: 64px; z-index: 99; }
        .progress-steps { max-width: 700px; margin: 0 auto; display: flex; gap: 4px; overflow-x: auto; padding-bottom: 4px; }
        .progress-step { flex: 1; min-width: 80px; text-align: center; padding: 8px 4px; border-radius: var(--radius-sm); font-size: 0.7rem; font-weight: 600; color: var(--text-secondary); background: var(--bg-primary); transition: all 0.3s; cursor: pointer; }
        .progress-step.active { background: var(--tradutema-blue); color: white; }
        .progress-step.completed { background: var(--accent-green); color: white; }
        .progress-step.locked { opacity: 0.5; cursor: not-allowed; }
        .step-num { display: block; font-size: 1rem; font-weight: 700; }
        
        /* MAIN */
        .main { max-width: 700px; margin: 0 auto; padding: 20px; }
        
        /* CARDS */
        .card { background: var(--bg-card); border-radius: var(--radius-lg); padding: 20px; margin-bottom: 16px; box-shadow: var(--shadow-md); border: 1px solid var(--border-color); }
        .card.hidden { display: none; }
        .card-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: var(--tradutema-blue); margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .card-title::before { content: ''; width: 4px; height: 16px; background: var(--tradutema-blue); border-radius: 2px; }
        .card-title .step-badge { background: var(--tradutema-blue); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; margin-left: auto; }
        
        /* FORM ELEMENTS */
        .form-group { margin-bottom: 16px; }
        label { display: block; font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-bottom: 8px; }
        select, input[type="text"], input[type="number"], input[type="email"], input[type="date"], input[type="time"], textarea {
            width: 100%; padding: 14px 16px; font-size: 1rem; font-family: inherit;
            border: 2px solid var(--border-color); border-radius: var(--radius-md);
            background: var(--bg-card); color: var(--text-primary); transition: all 0.2s;
        }
        select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; background-size: 20px; padding-right: 44px; -webkit-appearance: none; }
        select:focus, input:focus, textarea:focus { outline: none; border-color: var(--tradutema-blue); box-shadow: 0 0 0 3px rgba(52,152,219,0.1); }
        textarea { min-height: 80px; resize: vertical; }
        
        /* LANGUAGE ROW */
        .language-row { display: flex; gap: 12px; align-items: center; }
        .language-row .form-group { flex: 1; margin-bottom: 0; }
        .arrow-icon { font-size: 1.5rem; color: var(--tradutema-blue); margin-top: 24px; }
        
        /* CHANNEL SELECTOR */
        .channel-selector { display: flex; gap: 8px; margin-top: 16px; }
        .channel-btn { flex: 1; padding: 14px 8px; border: 2px solid var(--border-color); background: white; border-radius: var(--radius-md); font-family: inherit; font-size: 0.85rem; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .channel-btn:hover { border-color: var(--tradutema-blue-dark); }
        .channel-btn.selected { border-color: var(--tradutema-blue); background: rgba(52,152,219,0.05); }
        .channel-btn .channel-icon { font-size: 1.5rem; }
        .channel-btn.whatsapp.selected { border-color: #25d366; background: rgba(37,211,102,0.1); }
        .channel-btn.mail.selected { border-color: #ea4335; background: rgba(234,67,53,0.1); }
        .channel-btn.form.selected { border-color: var(--accent-gold); background: rgba(212,168,83,0.1); }
        
        /* FILE UPLOAD */
        .file-upload-area { border: 2px dashed var(--border-color); border-radius: var(--radius-md); padding: 24px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--bg-primary); }
        .file-upload-area:hover, .file-upload-area.dragover { border-color: var(--tradutema-blue); background: rgba(52,152,219,0.03); }
        .file-upload-area.has-files { border-color: var(--accent-green); background: rgba(46,204,113,0.05); }
        .file-upload-icon { font-size: 2.5rem; margin-bottom: 8px; }
        .file-upload-text { color: var(--text-secondary); font-size: 0.9rem; }
        .file-upload-text strong { color: var(--tradutema-blue); }
        .file-input { display: none; }
        .file-list { margin-top: 12px; }
        .file-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; background: white; border-radius: var(--radius-sm); margin-bottom: 8px; border: 1px solid var(--border-color); font-size: 0.85rem; }
        .file-item-info { display: flex; flex-direction: column; flex: 1; min-width: 0; }
        .file-item-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-item-size { font-size: 0.75rem; color: var(--text-secondary); }
        .file-item-size.file-size-large { color: var(--accent-orange); font-weight: 600; }
        .file-item-actions { display: flex; align-items: center; gap: 8px; }
        .file-item-remove { background: none; border: none; color: var(--accent-red); cursor: pointer; font-size: 1.2rem; padding: 4px 8px; }
        .file-total { font-size: 0.8rem; color: var(--text-secondary); margin-top: 8px; padding: 8px 12px; background: rgba(52,152,219,0.05); border-radius: var(--radius-sm); }
        
        /* COMPRESS CHECKBOX */
        .compress-checkbox { display: flex; align-items: center; cursor: pointer; }
        .compress-checkbox input { display: none; }
        .compress-checkbox .compress-label { font-size: 1.1rem; opacity: 0.4; transition: all 0.2s; padding: 4px; }
        .compress-checkbox input:checked + .compress-label { opacity: 1; }
        .compress-checkbox:hover .compress-label { opacity: 0.7; }
        .compress-count { color: var(--accent-orange); font-weight: 600; }
        
        /* BUTTONS */
        .btn { padding: 16px 24px; font-size: 1rem; font-weight: 600; font-family: inherit; border: none; border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { width: 100%; color: white; background: linear-gradient(135deg, var(--tradutema-blue) 0%, var(--tradutema-blue-dark) 100%); box-shadow: var(--shadow-md); }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-lg); }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-secondary { color: var(--text-secondary); background: white; border: 2px solid var(--border-color); }
        .btn-secondary:hover { border-color: var(--tradutema-blue); color: var(--tradutema-blue); }
        .btn-success { background: var(--accent-green) !important; }
        .btn-gold { background: linear-gradient(135deg, var(--accent-gold) 0%, #c4983f 100%) !important; }
        .btn-orange { background: linear-gradient(135deg, var(--accent-orange) 0%, #e67e22 100%) !important; }
        
        .btn-row { display: flex; gap: 12px; margin-top: 16px; }
        .btn-row .btn { flex: 1; }
        
        /* ACTION BUTTON (Big) */
        .action-btn { width: 100%; padding: 20px; font-size: 1.1rem; margin-top: 8px; }
        
        /* RESULTS BOX */
        .results-box { background: linear-gradient(135deg, rgba(52,152,219,0.05) 0%, rgba(212,168,83,0.1) 100%); border-radius: var(--radius-md); padding: 16px; margin-top: 16px; }
        .results-title { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--text-secondary); margin-bottom: 12px; }
        .results-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .result-item { background: white; padding: 12px; border-radius: var(--radius-sm); }
        .result-label { font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; }
        .result-value { font-family: 'Space Mono', monospace; font-size: 1.2rem; font-weight: 700; color: var(--tradutema-blue); }
        .result-item.highlight { background: var(--tradutema-blue); }
        .result-item.highlight .result-label { color: rgba(255,255,255,0.7); }
        .result-item.highlight .result-value { color: white; }
        .result-item.full-width { grid-column: 1 / -1; }
        
        /* WORD COUNT TABLE */
        .word-count-table { width: 100%; border-collapse: collapse; margin-top: 12px; font-size: 0.85rem; }
        .word-count-table th, .word-count-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .word-count-table th { background: var(--bg-primary); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: var(--text-secondary); }
        .word-count-table td.number { font-family: 'Space Mono', monospace; text-align: right; }
        .word-count-table tr.total { background: var(--tradutema-blue); color: white; font-weight: 600; }
        .word-count-table tr.total td { border-bottom: none; }
        
        /* TARIFF EDITOR */
        .tariff-editor { display: flex; align-items: center; gap: 8px; margin-top: 12px; padding: 12px; background: rgba(212,168,83,0.1); border-radius: var(--radius-sm); }
        .tariff-editor label { margin-bottom: 0; flex-shrink: 0; font-size: 0.85rem; }
        .tariff-editor input { width: 100px; padding: 8px 12px; text-align: right; font-family: 'Space Mono', monospace; }
        .tariff-editor .tariff-unit { color: var(--text-secondary); font-size: 0.85rem; }
        
        /* PAGE TARIFF INFO */
        .page-tariff-info { background: rgba(46,204,113,0.1); border: 1px solid rgba(46,204,113,0.3); border-radius: var(--radius-md); padding: 12px 16px; margin-bottom: 16px; }
        .page-tariff-label { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 4px; }
        .page-tariff-values { display: flex; gap: 16px; font-size: 0.95rem; }
        .page-tariff-values strong { color: var(--accent-green); font-family: 'Space Mono', monospace; }
        
        /* COUNT OPTIONS */
        .count-options { display: flex; flex-direction: column; gap: 12px; }
        .count-options .action-btn { margin-top: 0; }
        .btn-hint { font-size: 0.75rem; font-weight: 400; opacity: 0.8; margin-left: 4px; }
        
        .proposed-rate-fields { margin-top: 12px; padding: 12px; background: rgba(212,168,83,0.05); border-radius: var(--radius-md); border: 1px solid rgba(212,168,83,0.3); }
        .proposed-rate-fields.hidden { display: none; }
        
        /* PROVIDERS */
        .providers-list { display: flex; flex-direction: column; gap: 10px; max-height: 300px; overflow-y: auto; }
        .provider-item { display: flex; align-items: center; padding: 14px; border: 2px solid var(--border-color); border-radius: var(--radius-md); cursor: pointer; transition: all 0.2s; background: var(--bg-card); }
        .provider-item:hover { border-color: var(--tradutema-blue-dark); }
        .provider-item.selected { border-color: var(--tradutema-blue); background: rgba(52,152,219,0.05); }
        .provider-checkbox { width: 24px; height: 24px; border: 2px solid var(--border-color); border-radius: 6px; margin-right: 14px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
        .provider-item.selected .provider-checkbox { background: var(--tradutema-blue); border-color: var(--tradutema-blue); }
        .provider-checkbox::after { content: '‚úì'; color: white; font-weight: 700; font-size: 14px; opacity: 0; }
        .provider-item.selected .provider-checkbox::after { opacity: 1; }
        .provider-info { flex: 1; min-width: 0; }
        .provider-name { font-weight: 600; color: var(--text-primary); }
        .provider-email { font-size: 0.8rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; }
        .select-all-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid var(--border-color); }
        .select-all-btn { font-size: 0.85rem; color: var(--tradutema-blue); background: none; border: none; font-family: inherit; font-weight: 500; cursor: pointer; padding: 8px 12px; border-radius: var(--radius-sm); }
        .select-all-btn:hover { background: rgba(52,152,219,0.08); }
        .selected-count { font-size: 0.85rem; color: var(--text-secondary); }
        .no-providers { text-align: center; padding: 30px; color: var(--text-secondary); }
        
        /* CONTACTED PROVIDERS */
        .contacted-providers { margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border-color); }
        .contacted-list { display: flex; flex-direction: column; gap: 8px; }
        .contacted-item { display: flex; align-items: center; padding: 12px 14px; border: 2px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-card); cursor: pointer; transition: all 0.2s; }
        .contacted-item:hover { border-color: var(--tradutema-blue-dark); }
        .contacted-item.chosen { border-color: var(--accent-green); background: rgba(46,204,113,0.08); }
        .contacted-radio { width: 20px; height: 20px; border: 2px solid var(--border-color); border-radius: 50%; margin-right: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: all 0.2s; }
        .contacted-item.chosen .contacted-radio { border-color: var(--accent-green); }
        .contacted-item.chosen .contacted-radio::after { content: ''; width: 10px; height: 10px; background: var(--accent-green); border-radius: 50%; }
        .contacted-info { flex: 1; }
        .contacted-name { font-weight: 600; color: var(--text-primary); }
        .contacted-email { font-size: 0.8rem; color: var(--text-secondary); }
        .contacted-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; background: var(--accent-green); color: white; font-weight: 500; margin-left: 8px; }
        
        /* PROVIDER TAGS IN BUDGET LIST */
        .budget-item-providers { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color); }
        .provider-tag { font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; background: rgba(52,152,219,0.1); color: var(--tradutema-blue); font-weight: 500; }
        .provider-tag.chosen { background: var(--accent-green); color: white; }
        
        /* DEADLINE */
        .deadline-toggle { display: flex; gap: 8px; margin-bottom: 16px; }
        .toggle-btn { flex: 1; padding: 14px; border: 2px solid var(--border-color); background: var(--bg-card); border-radius: var(--radius-md); font-family: inherit; font-size: 0.9rem; font-weight: 500; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .toggle-btn.active { border-color: var(--tradutema-blue); background: var(--tradutema-blue); color: white; }
        .deadline-fields { display: none; gap: 12px; }
        .deadline-fields.visible { display: flex; }
        .deadline-fields .form-group { flex: 1; margin-bottom: 0; }
        
        /* CHECKBOXES */
        .checkbox-row { display: flex; align-items: center; padding: 12px 0; }
        .custom-checkbox { position: relative; width: 52px; height: 28px; background: var(--border-color); border-radius: 14px; cursor: pointer; transition: background 0.3s; margin-right: 12px; flex-shrink: 0; }
        .custom-checkbox.checked { background: var(--tradutema-blue); }
        .custom-checkbox::after { content: ''; position: absolute; top: 3px; left: 3px; width: 22px; height: 22px; background: white; border-radius: 50%; transition: transform 0.3s; }
        .custom-checkbox.checked::after { transform: translateX(24px); }
        .checkbox-label { font-size: 0.9rem; }
        
        /* CLIENT MESSAGE */
        .message-preview { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; font-size: 0.85rem; white-space: pre-wrap; line-height: 1.6; max-height: 300px; overflow-y: auto; margin-top: 12px; }
        .copy-buttons { display: flex; gap: 8px; margin-top: 12px; }
        .copy-btn { flex: 1; padding: 14px; font-size: 0.9rem; }
        .copy-btn.whatsapp { background: #25d366; color: white; border: none; }
        .copy-btn.email { background: #ea4335; color: white; border: none; }
        
        /* STATUS */
        .status-message { padding: 14px 16px; border-radius: var(--radius-md); margin-bottom: 16px; font-size: 0.9rem; display: none; align-items: center; gap: 10px; }
        .status-message.visible { display: flex; }
        .status-message.success { background: rgba(46,204,113,0.1); color: #1e8449; border: 1px solid rgba(46,204,113,0.3); }
        .status-message.error { background: rgba(231,76,60,0.1); color: #c0392b; border: 1px solid rgba(231,76,60,0.3); }
        .status-message.loading { background: rgba(52,152,219,0.08); color: var(--tradutema-blue); border: 1px solid rgba(52,152,219,0.2); }
        .status-message.warning { background: rgba(243,156,18,0.1); color: #d68910; border: 1px solid rgba(243,156,18,0.3); }
        
        /* MODALS */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 16px; }
        .modal-overlay.visible { display: flex; }
        .modal { background: white; width: 100%; max-width: 500px; max-height: 90vh; border-radius: var(--radius-lg); overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0; }
        .modal-title { font-weight: 600; font-size: 1.1rem; }
        .modal-close { width: 36px; height: 36px; border: none; background: var(--bg-primary); border-radius: 50%; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-body { padding: 16px 20px; overflow-y: auto; flex: 1; }
        .modal-footer { padding: 16px 20px; border-top: 1px solid var(--border-color); display: flex; gap: 12px; flex-shrink: 0; background: var(--bg-primary); }
        .modal-footer .btn { flex: 1; }
        
        /* EDITABLE MESSAGE */
        .editable-message { width: 100%; min-height: 200px; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-family: inherit; font-size: 0.9rem; line-height: 1.5; resize: vertical; }
        .editable-message:focus { outline: none; border-color: var(--tradutema-blue); }
        .preview-recipients { background: var(--bg-primary); padding: 12px; border-radius: var(--radius-md); margin-bottom: 12px; font-size: 0.85rem; }
        .preview-recipients strong { color: var(--tradutema-blue); }
        
        /* SUCCESS OVERLAY */
        .success-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(46,204,113,0.95); z-index: 2000; display: none; align-items: center; justify-content: center; flex-direction: column; color: white; }
        .success-overlay.visible { display: flex; }
        .success-checkmark { font-size: 5rem; margin-bottom: 20px; }
        .success-text { font-size: 1.5rem; font-weight: 600; }
        .success-subtext { font-size: 1rem; opacity: 0.9; margin-top: 8px; text-align: center; padding: 0 20px; }
        
        /* CONFIG */
        .config-section { background: rgba(52,152,219,0.03); border: 1px dashed var(--border-color); border-radius: var(--radius-md); padding: 16px; margin-bottom: 16px; }
        .config-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px; }
        .config-input { font-family: 'Space Mono', monospace; font-size: 0.85rem; }
        
        /* SPINNER */
        .spinner { width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; display: inline-block; }
        .spinner.dark { border-color: rgba(52,152,219,0.2); border-top-color: var(--tradutema-blue); }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* FOOTER */
        .footer { text-align: center; padding: 20px; color: var(--text-secondary); font-size: 0.75rem; }
        .footer a { color: var(--tradutema-blue); text-decoration: none; }
        .version-info { font-family: 'Space Mono', monospace; margin-top: 4px; opacity: 0.7; }
        
        /* HOME SCREEN */
        .home-screen { padding: 20px; max-width: 700px; margin: 0 auto; }
        .home-buttons { display: flex; flex-direction: column; gap: 16px; margin-bottom: 24px; }
        .home-btn { padding: 24px 20px; border: 2px solid var(--border-color); background: var(--bg-card); border-radius: var(--radius-lg); font-family: inherit; font-size: 1rem; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 16px; text-align: left; }
        .home-btn:hover { border-color: var(--tradutema-blue); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(52,152,219,0.2); }
        .home-btn-icon { font-size: 2rem; }
        .home-btn-text { flex: 1; }
        .home-btn-title { font-weight: 600; color: var(--text-primary); margin-bottom: 4px; }
        .home-btn-desc { font-size: 0.85rem; color: var(--text-secondary); }
        
        /* VERSION INDICATOR */
        .version-indicator { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 12px 16px; margin-top: 8px; }
        .version-row { display: flex; align-items: center; gap: 8px; padding: 4px 0; font-size: 0.8rem; font-family: 'Space Mono', monospace; }
        .version-label { color: var(--text-secondary); min-width: 40px; }
        .version-value { color: var(--tradutema-blue); font-weight: 500; }
        .version-value.error { color: var(--accent-red); }
        .version-value.ok { color: var(--accent-green); }
        .config-link { color: var(--tradutema-blue); text-decoration: none; font-size: 0.85rem; font-family: inherit; display: flex; align-items: center; gap: 4px; }
        .config-link:hover { text-decoration: underline; }
        
        /* BUDGET LIST */
        .budget-filters { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 16px; padding: 16px; background: var(--bg-primary); border-radius: var(--radius-md); }
        .budget-filters .form-group { margin-bottom: 0; }
        .budget-filters label { font-size: 0.75rem; }
        .budget-filters select, .budget-filters input { padding: 10px 12px; font-size: 0.85rem; }
        .budget-list { display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto; }
        .budget-item { padding: 14px 16px; border: 1px solid var(--border-color); border-radius: var(--radius-md); background: var(--bg-card); cursor: pointer; transition: all 0.2s; }
        .budget-item:hover { border-color: var(--tradutema-blue); background: rgba(52,152,219,0.03); }
        .budget-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .budget-item-id { font-weight: 600; font-family: 'Space Mono', monospace; color: var(--tradutema-blue); }
        .budget-item-status { font-size: 0.75rem; padding: 4px 10px; border-radius: 12px; font-weight: 500; }
        .budget-item-status.pendiente { background: rgba(243,156,18,0.15); color: #d68910; }
        .budget-item-status.tasacion { background: rgba(52,152,219,0.15); color: #2980b9; }
        .budget-item-status.enviado { background: rgba(46,204,113,0.15); color: #1e8449; }
        .budget-item-details { display: flex; flex-wrap: wrap; gap: 12px; font-size: 0.8rem; color: var(--text-secondary); }
        .budget-item-detail { display: flex; align-items: center; gap: 4px; }
        .no-budgets { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .back-btn { background: none; border: none; color: var(--tradutema-blue); font-family: inherit; font-size: 0.9rem; cursor: pointer; padding: 8px 0; margin-bottom: 12px; display: flex; align-items: center; gap: 6px; }
        .back-btn:hover { text-decoration: underline; }
        
        /* Hide elements */
        .hidden { display: none !important; }
        
        /* LANGUAGE TOGGLE */
        .lang-toggle { display: flex; gap: 4px; margin-bottom: 12px; }
        .lang-toggle button { padding: 8px 16px; border: 1px solid var(--border-color); background: white; font-family: inherit; font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .lang-toggle button:first-child { border-radius: var(--radius-sm) 0 0 var(--radius-sm); }
        .lang-toggle button:last-child { border-radius: 0 var(--radius-sm) var(--radius-sm) 0; }
        .lang-toggle button.active { background: var(--tradutema-blue); color: white; border-color: var(--tradutema-blue); }
        
        /* QUOTE FORM */
        .quote-row { display: flex; gap: 12px; }
        .quote-row .form-group { flex: 1; }
        
        /* LINK TO FOLDER */
        .folder-link { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: rgba(46,204,113,0.1); border-radius: var(--radius-sm); margin-top: 12px; text-decoration: none; color: var(--accent-green); font-weight: 500; transition: all 0.2s; }
        .folder-link:hover { background: rgba(46,204,113,0.2); }
        .folder-link-icon { font-size: 1.2rem; }

        /* Responsive */
        @media (max-width: 500px) {
            .progress-step { min-width: 60px; font-size: 0.65rem; }
            .step-num { font-size: 0.9rem; }
            .results-grid { grid-template-columns: 1fr; }
            .quote-row { flex-direction: column; gap: 0; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo" onclick="showHomeScreen()" style="cursor: pointer;">
                <svg class="logo-icon-svg" viewBox="0 0 40 40" width="36" height="36">
                    <circle cx="20" cy="20" r="18" fill="#3498db" stroke="#5d6d7e" stroke-width="2"/>
                    <text x="20" y="27" font-size="18" font-weight="bold" text-anchor="middle" fill="white" font-family="serif">TT</text>
                </svg>
                <span class="logo-text">QUOTES</span>
            </div>
            <div style="display: flex; align-items: center; gap: 12px;">
                <button class="home-link" onclick="showHomeScreen()" id="homeBtn" style="display: none;">üè† Inicio</button>
                <div class="budget-id" id="budgetIdDisplay">Sin crear</div>
            </div>
        </div>
    </header>

    <div class="progress-container hidden" id="progressContainer">
        <div class="progress-steps">
            <div class="progress-step active" data-step="1" onclick="goToStep(1)">
                <span class="step-num">1</span>
                Idiomas
            </div>
            <div class="progress-step locked" data-step="2" onclick="goToStep(2)">
                <span class="step-num">2</span>
                Archivos
            </div>
            <div class="progress-step locked" data-step="3" onclick="goToStep(3)">
                <span class="step-num">3</span>
                Carpeta
            </div>
            <div class="progress-step locked" data-step="4" onclick="goToStep(4)">
                <span class="step-num">4</span>
                Palabras
            </div>
            <div class="progress-step locked" data-step="5" onclick="goToStep(5)">
                <span class="step-num">5</span>
                Tasaci√≥n
            </div>
            <div class="progress-step locked" data-step="6" onclick="goToStep(6)">
                <span class="step-num">6</span>
                Cliente
            </div>
        </div>
    </div>

    <main class="main">
        <div id="statusMessage" class="status-message"></div>

        <!-- CONFIG (initially visible if no API) -->
        <div class="config-section" id="configSection">
            <div class="config-label">Configuraci√≥n API (una sola vez)</div>
            <input type="text" id="apiUrl" class="config-input" placeholder="Pega la URL del Apps Script (termina en /exec)">
            
            <div class="config-label" style="margin-top: 16px;">iLovePDF (opcional - para comprimir PDFs)</div>
            <input type="text" id="ilovepdfPublicKey" class="config-input" placeholder="Public Key de iLovePDF" style="margin-bottom: 8px;">
            <input type="text" id="ilovepdfSecretKey" class="config-input" placeholder="Secret Key de iLovePDF">
            
            <button class="btn btn-secondary" onclick="saveConfig()" style="margin-top: 10px; width: 100%;">Guardar y Conectar</button>
        </div>

        <!-- HOME SCREEN -->
        <div class="home-screen" id="homeScreen">
            <div class="home-buttons">
                <button class="home-btn" onclick="startNewBudget()">
                    <span class="home-btn-icon">üÜï</span>
                    <div class="home-btn-text">
                        <div class="home-btn-title">Nueva Tasaci√≥n</div>
                        <div class="home-btn-desc">Empezar desde cero con un nuevo presupuesto</div>
                    </div>
                </button>
                <button class="home-btn" onclick="showBudgetList()">
                    <span class="home-btn-icon">üìÇ</span>
                    <div class="home-btn-text">
                        <div class="home-btn-title">Retomar Tasaci√≥n</div>
                        <div class="home-btn-desc">Cargar un presupuesto pendiente</div>
                    </div>
                </button>
                <button class="home-btn" onclick="showQuickCount()">
                    <span class="home-btn-icon">üî¢</span>
                    <div class="home-btn-text">
                        <div class="home-btn-title">Contar Palabras</div>
                        <div class="home-btn-desc">Recuento r√°pido sin crear presupuesto</div>
                    </div>
                </button>
            </div>
            
            <!-- Indicador de versiones y acceso r√°pido -->
            <div class="version-indicator" id="homeVersionInfo">
                <div class="version-row">
                    <span class="version-label">HTML:</span>
                    <span class="version-value" id="htmlVersionDisplay">--</span>
                </div>
                <div class="version-row">
                    <span class="version-label">API:</span>
                    <span class="version-value" id="apiVersionDisplay">--</span>
                </div>
                <div class="version-row" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--border-color);">
                    <a href="https://docs.google.com/spreadsheets/d/1E75kTMGy4WSQbs04U4rkGKmPoR-B26hqX9S1Po1kX5w/edit" target="_blank" class="config-link">
                        üìä Abrir Google Sheet
                    </a>
                </div>
            </div>
        </div>

        <!-- QUICK WORD COUNT SCREEN -->
        <div class="card hidden" id="quickCountScreen">
            <button class="back-btn" onclick="showHomeScreen()">‚Üê Volver</button>
            
            <div class="card-title">Contar Palabras R√°pido</div>
            
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
                Arrastra archivos para contar palabras sin crear carpeta ni presupuesto.
            </p>
            
            <div class="file-upload-area" id="quickUploadArea" onclick="document.getElementById('quickFileInput').click()">
                <div class="file-upload-icon">üìÑ</div>
                <div class="file-upload-text">
                    <strong>Arrastra archivos aqu√≠ o toca para seleccionar</strong><br>
                    <small>PDF, im√°genes, Word (max 20MB total)</small>
                </div>
                <input type="file" id="quickFileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.webp,.tiff,.bmp" onchange="handleQuickFiles(this.files)">
            </div>
            
            <div class="file-list" id="quickFileList"></div>
            <div class="file-total" id="quickFileTotal" style="display:none;"></div>
            
            <button class="btn btn-primary btn-orange action-btn" id="quickCountBtn" onclick="doQuickCount()" style="display:none;">
                üî¢ Contar Palabras
            </button>
            
            <div class="results-box hidden" id="quickCountResults">
                <div class="results-title">Resultado del an√°lisis</div>
                <table class="word-count-table" id="quickCountTable">
                    <thead>
                        <tr>
                            <th>Archivo</th>
                            <th style="text-align:right">Palabras</th>
                            <th style="text-align:right">P√°ginas</th>
                        </tr>
                    </thead>
                    <tbody id="quickCountBody"></tbody>
                </table>
                
                <div class="totals-row" id="quickCountTotals"></div>
                
                <button class="btn btn-primary action-btn" onclick="copyQuickResults()" style="margin-top: 12px;">
                    üìã Copiar Resultado
                </button>
            </div>
        </div>

        <!-- BUDGET LIST SCREEN -->
        <div class="card hidden" id="budgetListScreen">
            <button class="back-btn" onclick="showHomeScreen()">‚Üê Volver</button>
            
            <div class="card-title">Presupuestos</div>
            
            <div class="budget-filters">
                <div class="form-group" style="grid-column: span 2;">
                    <label>üîç C√≥digo presupuesto</label>
                    <input type="text" id="filterCode" placeholder="Ej: 2412-00001" oninput="filterBudgets()" style="font-family: 'Space Mono', monospace;">
                </div>
                <div class="form-group">
                    <label>Estado</label>
                    <select id="filterStatus" onchange="filterBudgets()">
                        <option value="" selected>Todos</option>
                        <option value="Pendiente">Pendiente</option>
                        <option value="Tasaci√≥n enviada">Tasaci√≥n enviada</option>
                        <option value="Enviado">Enviado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Canal</label>
                    <select id="filterChannel" onchange="filterBudgets()">
                        <option value="">Todos</option>
                        <option value="W">WhatsApp</option>
                        <option value="M">Mail</option>
                        <option value="F">Formulario</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Idioma origen</label>
                    <select id="filterSource" onchange="filterBudgets()">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Idioma destino</label>
                    <select id="filterTarget" onchange="filterBudgets()">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Email cliente</label>
                    <input type="text" id="filterEmail" placeholder="Buscar..." oninput="filterBudgets()">
                </div>
                <div class="form-group">
                    <label>WhatsApp cliente</label>
                    <input type="text" id="filterWhatsApp" placeholder="Buscar..." oninput="filterBudgets()">
                </div>
                <div class="form-group">
                    <label>Desde fecha</label>
                    <input type="date" id="filterDateFrom" onchange="filterBudgets()">
                </div>
            </div>
            
            <div class="budget-list" id="budgetList">
                <div class="no-budgets">Cargando presupuestos...</div>
            </div>
        </div>

        <!-- STEP 1: IDIOMAS -->
        <div class="card hidden" id="step1Card">
            <div class="card-title">
                Combinaci√≥n de idiomas
                <span class="step-badge">PASO 1</span>
            </div>
            <div class="language-row">
                <div class="form-group">
                    <label>Idioma origen</label>
                    <select id="sourceLang" onchange="onLanguageChange()">
                        <option value="">Seleccionar...</option>
                    </select>
                </div>
                <div class="arrow-icon">‚Üí</div>
                <div class="form-group">
                    <label>Idioma destino</label>
                    <select id="targetLang" onchange="onLanguageChange()">
                        <option value="">Seleccionar...</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 16px;">
                <label>Canal de contacto</label>
                <div class="channel-selector">
                    <button class="channel-btn whatsapp" data-channel="W" onclick="selectChannel('W')">
                        <span class="channel-icon">üì±</span>
                        WhatsApp
                    </button>
                    <button class="channel-btn mail" data-channel="M" onclick="selectChannel('M')">
                        <span class="channel-icon">üìß</span>
                        Mail
                    </button>
                    <button class="channel-btn form" data-channel="F" onclick="selectChannel('F')">
                        <span class="channel-icon">üìù</span>
                        Formulario
                    </button>
                </div>
            </div>
            
            <!-- Contacto del cliente -->
            <div class="form-group" style="margin-top: 16px;">
                <label>Contacto del cliente (opcional)</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 8px;">
                    <input type="email" id="clientEmailStep1" placeholder="Email del cliente" oninput="onStep1Change()">
                    <input type="tel" id="clientWhatsAppStep1" placeholder="WhatsApp (+34...)" oninput="onStep1Change()">
                </div>
            </div>
            
            <button class="btn btn-primary action-btn" id="step1Btn" onclick="completeStep1()" disabled>
                Continuar a Archivos ‚Üí
            </button>
        </div>

        <!-- STEP 2: ARCHIVOS -->
        <div class="card hidden" id="step2Card">
            <div class="card-title">
                Documentos a traducir
                <span class="step-badge">PASO 2</span>
            </div>
            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="file-upload-icon">üìÑ</div>
                <div class="file-upload-text">
                    <strong>Toca para adjuntar archivos</strong><br>
                    <small>PDF, im√°genes, Word (max 20MB total)</small>
                </div>
                <input type="file" id="fileInput" class="file-input" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.webp,.tiff,.bmp" onchange="handleFiles(this.files)">
            </div>
            <div class="file-list" id="fileList"></div>
            <div class="file-total" id="fileTotal" style="display:none;"></div>
            
            <button class="btn btn-primary action-btn" id="step2Btn" onclick="completeStep2()" disabled>
                Continuar a Crear Carpeta ‚Üí
            </button>
        </div>

        <!-- STEP 3: CREAR CARPETA -->
        <div class="card hidden" id="step3Card">
            <div class="card-title">
                Crear carpeta de presupuesto
                <span class="step-badge">PASO 3</span>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
                Se crear√° una carpeta en Google Drive con el ID del presupuesto y se subir√°n los archivos.
            </p>
            
            <div class="results-box" id="folderPreview">
                <div class="results-title">Vista previa</div>
                <div class="results-grid">
                    <div class="result-item full-width">
                        <div class="result-label">ID Presupuesto</div>
                        <div class="result-value" id="previewBudgetId">--</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary btn-gold action-btn" id="step3Btn" onclick="createFolder()">
                üìÅ Crear Carpeta en Drive
            </button>
            
            <a href="#" class="folder-link hidden" id="folderLink" target="_blank">
                <span class="folder-link-icon">üìÇ</span>
                <span>Abrir carpeta en Google Drive</span>
            </a>
        </div>

        <!-- STEP 4: CONTAR PALABRAS -->
        <div class="card hidden" id="step4Card">
            <div class="card-title">
                An√°lisis de documentos
                <span class="step-badge">PASO 4 - Opcional</span>
            </div>
            
            <!-- Tarifa por p√°gina de esta combinaci√≥n -->
            <div class="page-tariff-info" id="pageTariffInfo">
                <div class="page-tariff-label">Tarifa por p√°gina (<span id="langPairDisplay">--</span>):</div>
                <div class="page-tariff-values">
                    <span><strong id="tariffPage1Display">--</strong> ‚Ç¨ (1¬™ p√°g)</span>
                    <span><strong id="tariffPage2Display">--</strong> ‚Ç¨ (resto)</span>
                </div>
            </div>
            
            <div class="count-options">
                <button class="btn btn-primary btn-success action-btn" id="countPagesBtn" onclick="countPagesOnly()">
                    üìÑ Solo P√°ginas <span class="btn-hint">(instant√°neo)</span>
                </button>
                
                <button class="btn btn-primary btn-orange action-btn" id="countWordsBtn" onclick="countWords()">
                    üî¢ Palabras + P√°ginas <span class="btn-hint">(m√°s lento)</span>
                </button>
            </div>
            
            <div class="results-box hidden" id="wordCountResults">
                <div class="results-title">Resultado del an√°lisis</div>
                <table class="word-count-table" id="wordCountTable">
                    <thead>
                        <tr>
                            <th>Archivo</th>
                            <th style="text-align:right">Palabras</th>
                            <th style="text-align:right">P√°ginas</th>
                        </tr>
                    </thead>
                    <tbody id="wordCountBody"></tbody>
                </table>
                
                <div class="tariff-editor" id="tariffEditorWords">
                    <label>Tarifa:</label>
                    <input type="number" id="customTariff" step="0.01" min="0" onchange="updateTotalPrice()">
                    <span class="tariff-unit">‚Ç¨/palabra</span>
                </div>
                
                <div class="results-grid" style="margin-top: 12px;">
                    <div class="result-item" id="resultByWords">
                        <div class="result-label">Por palabras</div>
                        <div class="result-value" id="priceByWords">0,00 ‚Ç¨</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Por p√°ginas</div>
                        <div class="result-value" id="priceByPages">0,00 ‚Ç¨</div>
                    </div>
                </div>
            </div>
            
            <div class="btn-row" style="margin-top: 16px;">
                <button class="btn btn-secondary" onclick="skipToStep(5)">Saltar</button>
                <button class="btn btn-primary" onclick="completeStep4()">Continuar ‚Üí</button>
            </div>
        </div>

        <!-- STEP 5: TASACI√ìN PROVEEDORES -->
        <div class="card hidden" id="step5Card">
            <div class="card-title">
                Solicitar tasaci√≥n a proveedores
                <span class="step-badge">PASO 5 - Opcional</span>
            </div>
            
            <!-- Opciones de la tasaci√≥n -->
            <div class="form-group">
                <label>Plazo de entrega</label>
                <div class="deadline-toggle">
                    <button class="toggle-btn active" id="deadlineOpen" onclick="setDeadlineType('open')">Plazo abierto</button>
                    <button class="toggle-btn" id="deadlineFixed" onclick="setDeadlineType('fixed')">Fecha espec√≠fica</button>
                </div>
                <div class="deadline-fields" id="deadlineFields">
                    <div class="form-group">
                        <label>Fecha</label>
                        <input type="date" id="deadlineDate">
                    </div>
                    <div class="form-group">
                        <label>Hora</label>
                        <input type="time" id="deadlineTime" value="18:00">
                    </div>
                </div>
            </div>
            
            <div class="checkbox-row">
                <div class="custom-checkbox" id="includeWordCount" onclick="toggleCheckbox('includeWordCount')"></div>
                <span class="checkbox-label">Incluir recuento de palabras/p√°ginas</span>
            </div>
            
            <div class="checkbox-row">
                <div class="custom-checkbox" id="includeProposedRate" onclick="toggleCheckbox('includeProposedRate'); toggleProposedRateFields()"></div>
                <span class="checkbox-label">Incluir Proposici√≥n Tarifa</span>
            </div>
            
            <div class="proposed-rate-fields hidden" id="proposedRateFields">
                <div class="tariff-editor">
                    <label>Tarifa:</label>
                    <input type="number" id="proposedTariff" step="0.01" min="0" onchange="updateProposedTotal()">
                    <span class="tariff-unit">‚Ç¨/palabra</span>
                </div>
                <div class="tariff-editor" style="margin-top: 8px;">
                    <label>Total:</label>
                    <input type="number" id="proposedTotal" step="0.01" min="0">
                    <span class="tariff-unit">‚Ç¨</span>
                </div>
            </div>
            
            <div class="form-group">
                <label>Comentarios adicionales</label>
                <textarea id="providerComments" placeholder="Detalles sobre el documento, formato de entrega, etc."></textarea>
            </div>
            
            <!-- Proveedores -->
            <div style="margin-top: 20px;">
                <div class="card-title" style="margin-bottom: 12px;">Seleccionar proveedores</div>
                <div class="select-all-row">
                    <button class="select-all-btn" onclick="toggleSelectAll()">Seleccionar todos</button>
                    <span class="selected-count" id="selectedCount">0 seleccionados</span>
                </div>
                <div class="providers-list" id="providersList">
                    <div class="no-providers">
                        <div>Cargando proveedores...</div>
                    </div>
                </div>
            </div>
            
            <button class="btn btn-primary action-btn" id="sendQuoteBtn" onclick="previewProviderEmail()" disabled>
                ‚úâÔ∏è Previsualizar y Enviar Tasaci√≥n
            </button>
            
            <!-- Traductores contactados (aparece despu√©s de enviar) -->
            <div class="contacted-providers hidden" id="contactedProvidersSection">
                <div class="card-title" style="margin-top: 20px; margin-bottom: 12px;">
                    üìã Traductores contactados
                    <span style="font-size: 0.8rem; font-weight: normal; color: var(--text-secondary);">
                        (Selecciona el elegido para el presupuesto)
                    </span>
                </div>
                <div class="contacted-list" id="contactedProvidersList"></div>
            </div>
            
            <div class="btn-row">
                <button class="btn btn-secondary" onclick="skipToStep(6)">Saltar a Cliente</button>
            </div>
        </div>

        <!-- STEP 6: PRESUPUESTO CLIENTE -->
        <div class="card hidden" id="step6Card">
            <div class="card-title">
                Enviar presupuesto al cliente
                <span class="step-badge">PASO 6</span>
            </div>
            
            <div class="lang-toggle">
                <button class="active" onclick="setMessageLang('es')">Espa√±ol</button>
                <button onclick="setMessageLang('en')">English</button>
            </div>
            
            <div class="quote-row">
                <div class="form-group">
                    <label>Importe (‚Ç¨, IVA incluido)</label>
                    <input type="number" id="quoteAmount" step="0.01" min="0" placeholder="Ej: 85.00" onchange="updateClientMessage()">
                </div>
                <div class="form-group">
                    <label>Plazo (d√≠as laborables)</label>
                    <input type="number" id="quoteDays" min="1" placeholder="Ej: 3" onchange="updateClientMessage()">
                </div>
            </div>
            
            <div class="quote-row">
                <div class="form-group">
                    <label>Recargo urgencia (‚Ç¨, opcional)</label>
                    <input type="number" id="quoteUrgency" step="0.01" min="0" placeholder="Ej: 15.00" onchange="updateClientMessage()">
                </div>
            </div>
            
            <div class="form-group">
                <label>Email del cliente (opcional, para env√≠o directo)</label>
                <input type="email" id="clientEmail" placeholder="cliente@email.com">
            </div>
            
            <div class="form-group">
                <label>WhatsApp del cliente (opcional)</label>
                <input type="tel" id="clientWhatsApp" placeholder="+34 612 345 678">
            </div>
            
            <div class="form-group">
                <label style="font-weight: 600;">Mensaje al cliente (editable):</label>
                <textarea class="editable-message" id="clientMessageEdit" rows="10" oninput="onClientMessageEdit()"></textarea>
            </div>
            
            <div class="copy-buttons">
                <button class="btn copy-btn whatsapp" onclick="copyForWhatsApp()">
                    üì± Copiar WhatsApp
                </button>
                <button class="btn copy-btn email" onclick="copyForEmail()">
                    üìß Copiar Email
                </button>
            </div>
            
            <button class="btn btn-primary btn-success action-btn" id="sendClientBtn" onclick="sendClientEmail()" style="margin-top: 12px;">
                ‚úâÔ∏è Enviar Email al Cliente
            </button>
        </div>
    </main>

    <footer class="footer">
        <div>Tradutema QUOTES 2025 - <a href="#" onclick="showConfig(); return false;">Cambiar API</a></div>
        <div class="version-info" id="versionInfo">HTML v2.8.0 | API: ?</div>
    </footer>

    <!-- Modal Preview Proveedor -->
    <div class="modal-overlay" id="providerPreviewModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Vista previa - Tasaci√≥n</span>
                <button class="modal-close" onclick="closeProviderModal()">‚úï</button>
            </div>
            <div class="modal-body">
                <div class="preview-recipients" id="previewRecipients"></div>
                <label style="font-weight: 600; margin-bottom: 8px; display: block;">Mensaje (editable):</label>
                <textarea class="editable-message" id="providerMessageEdit" rows="12"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeProviderModal()">Cancelar</button>
                <button class="btn btn-primary btn-success" onclick="sendProviderEmails()">Enviar</button>
            </div>
        </div>
    </div>

    <!-- Success Overlay -->
    <div class="success-overlay" id="successOverlay">
        <div class="success-checkmark">‚úì</div>
        <div class="success-text" id="successText">¬°Completado!</div>
        <div class="success-subtext" id="successSubtext"></div>
    </div>

    <script>
        /**
         * TRADUTEMA QUOTES - Gestor de Presupuestos
         * HTML Version: 2.8.0
         * Fecha: 30/12/2025 12:30
         */

        const HTML_VERSION = '2.8.0';
        const HTML_DATE = '30/12/2025 12:30';
        const MAX_FILE_SIZE = 20 * 1024 * 1024;

        // State
        let apiUrl = localStorage.getItem('tradutema_api_url') || '';
        let apiVersion = '?';
        let apiDate = '';
        let allProviders = [];
        let allTariffs = [];
        let allBudgets = [];
        let filteredBudgets = [];
        let filteredProviders = [];
        let selectedProviders = new Set();
        let uploadedFiles = [];
        let currentStep = 1;
        let completedSteps = new Set();
        let isResuming = false;
        
        // iLovePDF
        let ilovepdfPublicKey = localStorage.getItem('tradutema_ilovepdf_public') || '';
        let ilovepdfSecretKey = localStorage.getItem('tradutema_ilovepdf_secret') || '';
        let filesToCompress = new Set();  // √çndices de archivos marcados para comprimir
        
        // Budget data
        let budgetData = {
            id: null,
            folderId: null,
            folderUrl: null,
            sourceLang: '',
            targetLang: '',
            channel: '',
            clientEmail: '',
            clientWhatsApp: '',
            wordCount: null,
            pageCount: null,
            fileAnalysis: [],
            tariffPerWord: 0,
            tariffPage1: 0,
            tariffPage2: 0,
            contactedProviders: [],  // Traductores a los que se envi√≥ tasaci√≥n
            chosenProvider: null     // Traductor elegido para el presupuesto
        };
        
        let deadlineType = 'open';
        let messageLang = 'es';
        let clientMessageEdited = false;  // Para rastrear si el usuario edit√≥ el mensaje

        // ====== INIT ======
        document.addEventListener('DOMContentLoaded', () => {
            if (apiUrl) {
                document.getElementById('configSection').style.display = 'none';
                loadData();
            }
            updateClientMessage();
            
            // Setup drag & drop for file upload
            const dropArea = document.getElementById('fileUploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.add('dragover'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, () => dropArea.classList.remove('dragover'), false);
            });
            
            dropArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                handleFiles(files);
            }, false);
            
            // Setup drag & drop for quick count
            const quickDropArea = document.getElementById('quickUploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                quickDropArea.addEventListener(eventName, preventDefaults, false);
            });
            
            ['dragenter', 'dragover'].forEach(eventName => {
                quickDropArea.addEventListener(eventName, () => quickDropArea.classList.add('dragover'), false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                quickDropArea.addEventListener(eventName, () => quickDropArea.classList.remove('dragover'), false);
            });
            
            quickDropArea.addEventListener('drop', (e) => {
                const files = e.dataTransfer.files;
                handleQuickFiles(files);
            }, false);
        });

        // ====== CONFIG ======
        function saveConfig() {
            const url = document.getElementById('apiUrl').value.trim();
            if (!url || !url.includes('/exec')) {
                showStatus('URL inv√°lida. Debe terminar en /exec', 'error');
                return;
            }
            apiUrl = url;
            localStorage.setItem('tradutema_api_url', url);
            
            // Guardar keys de iLovePDF (opcionales)
            const publicKey = document.getElementById('ilovepdfPublicKey').value.trim();
            const secretKey = document.getElementById('ilovepdfSecretKey').value.trim();
            if (publicKey) localStorage.setItem('tradutema_ilovepdf_public', publicKey);
            if (secretKey) localStorage.setItem('tradutema_ilovepdf_secret', secretKey);
            ilovepdfPublicKey = publicKey;
            ilovepdfSecretKey = secretKey;
            
            document.getElementById('configSection').style.display = 'none';
            loadData();
        }

        function showConfig() {
            document.getElementById('configSection').style.display = 'block';
            document.getElementById('apiUrl').value = apiUrl;
            document.getElementById('ilovepdfPublicKey').value = ilovepdfPublicKey || '';
            document.getElementById('ilovepdfSecretKey').value = ilovepdfSecretKey || '';
        }

        // ====== HOME SCREEN ======
        function showHomeScreen() {
            document.getElementById('homeScreen').classList.remove('hidden');
            document.getElementById('budgetListScreen').classList.add('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('quickCountScreen').classList.add('hidden');
            document.querySelectorAll('.card').forEach(c => c.classList.add('hidden'));
            document.getElementById('budgetIdDisplay').textContent = 'Sin crear';
            document.getElementById('homeBtn').style.display = 'none';
            
            // Reset state
            resetBudgetState();
        }

        function resetBudgetState() {
            budgetData = {
                id: null, folderId: null, folderUrl: null,
                sourceLang: '', targetLang: '', channel: '',
                clientEmail: '', clientWhatsApp: '',
                wordCount: null, pageCount: null, fileAnalysis: [],
                tariffPerWord: 0, tariffPage1: 0, tariffPage2: 0,
                contactedProviders: [], chosenProvider: null
            };
            uploadedFiles = [];
            selectedProviders.clear();
            completedSteps.clear();
            filesToCompress.clear();  // Limpiar marcas de compresi√≥n
            currentStep = 1;
            isResuming = false;
            clientMessageEdited = false;  // Reset flag de mensaje editado
            
            // Reset UI - con verificaci√≥n de existencia
            const sourceLang = document.getElementById('sourceLang');
            const targetLang = document.getElementById('targetLang');
            const clientEmail = document.getElementById('clientEmail');
            const clientWhatsApp = document.getElementById('clientWhatsApp');
            const clientEmailStep1 = document.getElementById('clientEmailStep1');
            const clientWhatsAppStep1 = document.getElementById('clientWhatsAppStep1');
            const fileList = document.getElementById('fileList');
            const fileTotal = document.getElementById('fileTotal');
            const fileInput = document.getElementById('fileInput');
            const fileUploadArea = document.getElementById('fileUploadArea');
            const folderLink = document.getElementById('folderLink');
            const wordCountResults = document.getElementById('wordCountResults');
            const step1Btn = document.getElementById('step1Btn');
            const step2Btn = document.getElementById('step2Btn');
            const contactedSection = document.getElementById('contactedProvidersSection');
            
            // Reset paso 6 fields
            const quoteAmount = document.getElementById('quoteAmount');
            const quoteDays = document.getElementById('quoteDays');
            const quoteUrgency = document.getElementById('quoteUrgency');
            const clientMessagePreview = document.getElementById('clientMessagePreview');
            
            // Reset form fields
            if (sourceLang) sourceLang.value = '';
            if (targetLang) targetLang.value = '';
            if (clientEmail) clientEmail.value = '';
            if (clientWhatsApp) clientWhatsApp.value = '';
            if (clientEmailStep1) clientEmailStep1.value = '';
            if (clientWhatsAppStep1) clientWhatsAppStep1.value = '';
            document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('selected'));
            
            // Reset contacted providers section
            if (contactedSection) contactedSection.classList.add('hidden');
            document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('selected'));
            
            // Reset file upload area completely
            if (fileList) fileList.innerHTML = '';
            if (fileTotal) fileTotal.style.display = 'none';
            if (fileInput) fileInput.value = ''; // Reset file input
            if (fileUploadArea) fileUploadArea.classList.remove('has-files');
            
            // Reset folder link
            if (folderLink) folderLink.classList.add('hidden');
            
            // Reset word count results
            if (wordCountResults) wordCountResults.classList.add('hidden');
            
            // Reset paso 6 fields
            if (quoteAmount) quoteAmount.value = '';
            if (quoteDays) quoteDays.value = '';
            if (quoteUrgency) quoteUrgency.value = '';
            if (clientMessagePreview) clientMessagePreview.innerHTML = '';
            
            // Reset buttons
            if (step1Btn) step1Btn.disabled = true;
            if (step2Btn) step2Btn.disabled = true;
            
            // Reset budget ID display
            document.getElementById('budgetIdDisplay').textContent = 'Sin crear';
            document.getElementById('budgetIdDisplay').classList.remove('active');
            
            // Force update progress steps to remove all 'completed' classes
            updateProgressSteps();
        }

        function startNewBudget() {
            resetBudgetState();
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('budgetListScreen').classList.add('hidden');
            document.getElementById('progressContainer').classList.remove('hidden');
            document.getElementById('step1Card').classList.remove('hidden');
            document.getElementById('homeBtn').style.display = 'flex';
            updateProgressSteps();
        }

        async function showBudgetList() {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('budgetListScreen').classList.remove('hidden');
            document.getElementById('quickCountScreen').classList.add('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('homeBtn').style.display = 'flex';
            
            await loadBudgets();
        }

        // ====== QUICK WORD COUNT ======
        let quickFiles = [];
        
        function showQuickCount() {
            document.getElementById('homeScreen').classList.add('hidden');
            document.getElementById('budgetListScreen').classList.add('hidden');
            document.getElementById('quickCountScreen').classList.remove('hidden');
            document.getElementById('progressContainer').classList.add('hidden');
            document.getElementById('homeBtn').style.display = 'flex';
            
            // Reset quick count state
            quickFiles = [];
            document.getElementById('quickFileList').innerHTML = '';
            document.getElementById('quickFileTotal').style.display = 'none';
            document.getElementById('quickCountBtn').style.display = 'none';
            document.getElementById('quickCountResults').classList.add('hidden');
            document.getElementById('quickFileInput').value = '';
            document.getElementById('quickUploadArea').classList.remove('has-files');
        }
        
        function handleQuickFiles(files) {
            for (const file of files) {
                if (quickFiles.some(f => f.name === file.name)) continue;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result.split(',')[1];
                    quickFiles.push({
                        name: file.name,
                        size: file.size,
                        type: file.type || 'application/octet-stream',
                        content: base64
                    });
                    renderQuickFiles();
                };
                reader.readAsDataURL(file);
            }
        }
        
        function renderQuickFiles() {
            const list = document.getElementById('quickFileList');
            const total = document.getElementById('quickFileTotal');
            const area = document.getElementById('quickUploadArea');
            const btn = document.getElementById('quickCountBtn');
            
            if (quickFiles.length === 0) {
                list.innerHTML = '';
                total.style.display = 'none';
                area.classList.remove('has-files');
                btn.style.display = 'none';
                return;
            }
            
            area.classList.add('has-files');
            btn.style.display = 'block';
            
            let html = '';
            let totalSize = 0;
            quickFiles.forEach((file, idx) => {
                totalSize += file.size;
                const sizeStr = file.size > 1024*1024 
                    ? (file.size / (1024*1024)).toFixed(1) + ' MB'
                    : (file.size / 1024).toFixed(0) + ' KB';
                html += `
                    <div class="file-item">
                        <div class="file-item-info">
                            <span class="file-item-name">${file.name}</span>
                            <span class="file-item-size">${sizeStr}</span>
                        </div>
                        <button class="file-remove" onclick="removeQuickFile(${idx})">‚úï</button>
                    </div>
                `;
            });
            list.innerHTML = html;
            
            const totalStr = totalSize > 1024*1024 
                ? (totalSize / (1024*1024)).toFixed(1) + ' MB'
                : (totalSize / 1024).toFixed(0) + ' KB';
            total.innerHTML = `${quickFiles.length} archivo(s) - <strong>${totalStr}</strong> total`;
            total.style.display = 'block';
        }
        
        function removeQuickFile(idx) {
            quickFiles.splice(idx, 1);
            renderQuickFiles();
        }
        
        async function doQuickCount() {
            if (quickFiles.length === 0) return;
            
            const btn = document.getElementById('quickCountBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Contando...';
            
            try {
                showStatus('Analizando documentos...', 'loading');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'quickCount',
                        files: quickFiles
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    hideStatus();
                    
                    // Render results table
                    const tbody = document.getElementById('quickCountBody');
                    let html = '';
                    let totalWords = 0;
                    let totalPages = 0;
                    
                    data.files.forEach(f => {
                        totalWords += f.words || 0;
                        totalPages += f.pages || 0;
                        html += `
                            <tr>
                                <td>${f.name}</td>
                                <td style="text-align:right">${(f.words || 0).toLocaleString('es-ES')}</td>
                                <td style="text-align:right">${f.pages || 0}</td>
                            </tr>
                        `;
                    });
                    tbody.innerHTML = html;
                    
                    // Totals
                    document.getElementById('quickCountTotals').innerHTML = `
                        <div class="results-grid">
                            <div class="result-item">
                                <div class="result-label">Total palabras</div>
                                <div class="result-value">${totalWords.toLocaleString('es-ES')}</div>
                            </div>
                            <div class="result-item">
                                <div class="result-label">Total p√°ginas</div>
                                <div class="result-value">${totalPages}</div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('quickCountResults').classList.remove('hidden');
                    
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
                setTimeout(hideStatus, 3000);
            }
            
            btn.disabled = false;
            btn.innerHTML = 'üî¢ Contar Palabras';
        }
        
        function copyQuickResults() {
            const tbody = document.getElementById('quickCountBody');
            const rows = tbody.querySelectorAll('tr');
            
            let text = 'Archivo\tPalabras\tP√°ginas\n';
            let totalWords = 0;
            let totalPages = 0;
            
            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const name = cells[0].textContent;
                const words = parseInt(cells[1].textContent.replace(/\./g, '')) || 0;
                const pages = parseInt(cells[2].textContent) || 0;
                totalWords += words;
                totalPages += pages;
                text += `${name}\t${words}\t${pages}\n`;
            });
            
            text += `\nTOTAL\t${totalWords}\t${totalPages}`;
            
            navigator.clipboard.writeText(text).then(() => {
                showStatus('‚úì Copiado al portapapeles', 'success');
                setTimeout(hideStatus, 2000);
            });
        }

        // Guardar contacto del cliente
        function onContactChange() {
            const email = document.getElementById('clientEmail');
            const whatsapp = document.getElementById('clientWhatsApp');
            if (email) budgetData.clientEmail = email.value.trim();
            if (whatsapp) budgetData.clientWhatsApp = whatsapp.value.trim();
        }

        async function loadBudgets() {
            document.getElementById('budgetList').innerHTML = '<div class="no-budgets"><span class="spinner dark"></span> Cargando...</div>';
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getBudgets' })
                });
                const data = await response.json();
                
                if (data.success) {
                    allBudgets = data.budgets || [];
                    populateFilterLanguages();
                    filterBudgets();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                document.getElementById('budgetList').innerHTML = `<div class="no-budgets">Error: ${error.message}</div>`;
            }
        }

        function populateFilterLanguages() {
            const sourceLangs = new Set();
            const targetLangs = new Set();
            allBudgets.forEach(b => {
                if (b.origen) sourceLangs.add(b.origen);
                if (b.destino) targetLangs.add(b.destino);
            });
            
            const selectSource = document.getElementById('filterSource');
            selectSource.innerHTML = '<option value="">Todos</option>';
            [...sourceLangs].sort().forEach(lang => {
                selectSource.innerHTML += `<option value="${lang}">${lang}</option>`;
            });
            
            const selectTarget = document.getElementById('filterTarget');
            selectTarget.innerHTML = '<option value="">Todos</option>';
            [...targetLangs].sort().forEach(lang => {
                selectTarget.innerHTML += `<option value="${lang}">${lang}</option>`;
            });
        }

        function filterBudgets() {
            const code = document.getElementById('filterCode').value.toLowerCase().trim();
            const status = document.getElementById('filterStatus').value;
            const channel = document.getElementById('filterChannel').value;
            const source = document.getElementById('filterSource').value;
            const target = document.getElementById('filterTarget').value;
            const email = document.getElementById('filterEmail').value.toLowerCase().trim();
            const whatsapp = document.getElementById('filterWhatsApp').value.trim();
            const dateFrom = document.getElementById('filterDateFrom').value;
            
            filteredBudgets = allBudgets.filter(b => {
                if (code && (!b.id || !b.id.toLowerCase().includes(code))) return false;
                if (status && b.estado !== status) return false;
                if (channel && b.canal !== channel) return false;
                if (source && b.origen !== source) return false;
                if (target && b.destino !== target) return false;
                if (email && (!b.emailCliente || !String(b.emailCliente).toLowerCase().includes(email))) return false;
                if (whatsapp && (!b.whatsappCliente || !String(b.whatsappCliente).includes(whatsapp))) return false;
                if (dateFrom) {
                    const budgetDate = new Date(b.fecha);
                    const filterDate = new Date(dateFrom);
                    if (budgetDate < filterDate) return false;
                }
                return true;
            });
            
            renderBudgetList();
        }

        function renderBudgetList() {
            const container = document.getElementById('budgetList');
            
            if (filteredBudgets.length === 0) {
                container.innerHTML = '<div class="no-budgets">No hay presupuestos con estos filtros</div>';
                return;
            }
            
            let html = '';
            filteredBudgets.forEach(b => {
                const statusClass = b.estado === 'Pendiente' ? 'pendiente' : 
                                   b.estado === 'Tasaci√≥n enviada' ? 'tasacion' : 'enviado';
                const fecha = new Date(b.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: '2-digit' });
                const canal = b.canal === 'W' ? 'üì± WhatsApp' : b.canal === 'M' ? 'üìß Mail' : 'üìù Form';
                
                // Mostrar contacto del cliente si existe
                let contactoHtml = '';
                if (b.emailCliente) {
                    contactoHtml += `<span class="budget-item-detail">‚úâÔ∏è ${b.emailCliente}</span>`;
                }
                if (b.whatsappCliente) {
                    contactoHtml += `<span class="budget-item-detail">üìû ${b.whatsappCliente}</span>`;
                }
                
                // Mostrar traductores contactados y elegido
                let traductoresHtml = '';
                if (b.traductoresContactados) {
                    const traductores = b.traductoresContactados.split(',').map(t => t.trim()).filter(t => t);
                    if (traductores.length > 0) {
                        traductoresHtml = '<div class="budget-item-providers">';
                        traductores.forEach(t => {
                            const isChosen = b.traductorElegido && t === b.traductorElegido;
                            traductoresHtml += `<span class="provider-tag ${isChosen ? 'chosen' : ''}">${t}${isChosen ? ' ‚úì' : ''}</span>`;
                        });
                        traductoresHtml += '</div>';
                    }
                }
                
                html += `
                    <div class="budget-item" onclick="loadBudget('${b.id}')">
                        <div class="budget-item-header">
                            <span class="budget-item-id">${b.id}</span>
                            <span class="budget-item-status ${statusClass}">${b.estado}</span>
                        </div>
                        <div class="budget-item-details">
                            <span class="budget-item-detail">üìÖ ${fecha}</span>
                            <span class="budget-item-detail">${canal}</span>
                            <span class="budget-item-detail">üåê ${b.origen} ‚Üí ${b.destino}</span>
                            ${b.palabras ? `<span class="budget-item-detail">üìù ${parseInt(b.palabras).toLocaleString('es-ES')} palabras</span>` : ''}
                            ${contactoHtml}
                        </div>
                        ${traductoresHtml}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function loadBudget(budgetId) {
            showStatus('Cargando presupuesto...', 'loading');
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({ action: 'getBudget', budgetId: budgetId })
                });
                const data = await response.json();
                
                if (data.success) {
                    const b = data.budget;
                    
                    // Restore budget data
                    budgetData.id = b.id;
                    budgetData.folderId = b.folderId;
                    budgetData.folderUrl = b.folderUrl;
                    budgetData.sourceLang = b.origen;
                    budgetData.targetLang = b.destino;
                    budgetData.channel = b.canal;
                    budgetData.wordCount = b.palabras ? parseInt(b.palabras) : null;
                    budgetData.pageCount = b.paginas ? parseInt(b.paginas) : null;
                    budgetData.tariffPerWord = b.tarifa ? parseFloat(b.tarifa) : 0;
                    budgetData.clientEmail = b.emailCliente || '';
                    budgetData.clientWhatsApp = b.whatsappCliente || '';
                    
                    // Restaurar traductores contactados
                    if (b.traductoresContactados) {
                        budgetData.contactedProviders = b.traductoresContactados.split(',').map(t => ({
                            nombre: t.trim(),
                            email: ''
                        })).filter(p => p.nombre);
                    } else {
                        budgetData.contactedProviders = [];
                    }
                    budgetData.chosenProvider = b.traductorElegido || null;
                    
                    isResuming = true;
                    
                    // Set completed steps based on what data exists
                    completedSteps.clear();
                    completedSteps.add(1); // Languages always done
                    completedSteps.add(2); // Files always uploaded
                    completedSteps.add(3); // Folder always created
                    if (budgetData.wordCount) completedSteps.add(4);
                    if (b.estado === 'Tasaci√≥n enviada' || b.estado === 'Enviado') completedSteps.add(5);
                    if (b.estado === 'Enviado') completedSteps.add(6);
                    
                    // Update UI
                    document.getElementById('sourceLang').value = budgetData.sourceLang;
                    document.getElementById('targetLang').value = budgetData.targetLang;
                    document.querySelectorAll('.channel-btn').forEach(btn => {
                        btn.classList.toggle('selected', btn.dataset.channel === budgetData.channel);
                    });
                    document.getElementById('budgetIdDisplay').textContent = budgetData.id;
                    
                    // Restaurar campos contacto en paso 1
                    const clientEmailStep1 = document.getElementById('clientEmailStep1');
                    const clientWhatsAppStep1 = document.getElementById('clientWhatsAppStep1');
                    if (clientEmailStep1) clientEmailStep1.value = budgetData.clientEmail;
                    if (clientWhatsAppStep1) clientWhatsAppStep1.value = budgetData.clientWhatsApp;
                    
                    // Mostrar traductores contactados si existen
                    if (budgetData.contactedProviders.length > 0) {
                        renderContactedProviders();
                        document.getElementById('contactedProvidersSection').classList.remove('hidden');
                    }
                    
                    // Show folder link
                    if (budgetData.folderUrl) {
                        const folderLink = document.getElementById('folderLink');
                        if (folderLink) {
                            folderLink.href = budgetData.folderUrl;
                            folderLink.classList.remove('hidden');
                        }
                        const previewId = document.getElementById('previewBudgetId');
                        if (previewId) previewId.textContent = budgetData.id;
                    }
                    
                    // Update tariff
                    onLanguageChange();
                    
                    // Show workflow
                    document.getElementById('homeScreen').classList.add('hidden');
                    document.getElementById('budgetListScreen').classList.add('hidden');
                    document.getElementById('progressContainer').classList.remove('hidden');
                    document.getElementById('homeBtn').style.display = 'flex';
                    
                    updateProgressSteps();
                    hideStatus();
                    
                    // Go to the appropriate step
                    let targetStep = 6; // Default to client step
                    if (!budgetData.wordCount) targetStep = 4;
                    if (b.estado === 'Enviado') targetStep = 6;
                    
                    showCard(targetStep);
                    updateClientMessage();
                    
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
        }

        // ====== LOAD DATA ======
        async function loadData() {
            showStatus('Conectando...', 'loading');
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.success) {
                    allProviders = data.providers || [];
                    allTariffs = data.tariffs || [];
                    apiVersion = data.version || '?';
                    apiDate = data.versionDate || '';
                    
                    // Actualizar footer
                    document.getElementById('versionInfo').textContent = `HTML v${HTML_VERSION} | API: ${apiVersion}`;
                    
                    // Actualizar indicador en home
                    updateVersionIndicator();
                    
                    populateLanguages();
                    hideStatus();
                } else {
                    throw new Error(data.error || 'Error desconocido');
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
                updateVersionIndicator(true);
            }
        }
        
        function updateVersionIndicator(error = false) {
            const htmlDisplay = document.getElementById('htmlVersionDisplay');
            const apiDisplay = document.getElementById('apiVersionDisplay');
            
            if (htmlDisplay) {
                htmlDisplay.textContent = `v${HTML_VERSION} (${HTML_DATE})`;
                htmlDisplay.classList.add('ok');
            }
            
            if (apiDisplay) {
                if (error) {
                    apiDisplay.textContent = 'Error de conexi√≥n';
                    apiDisplay.classList.add('error');
                } else if (apiVersion && apiVersion !== '?') {
                    apiDisplay.textContent = `v${apiVersion}${apiDate ? ' (' + apiDate + ')' : ''}`;
                    apiDisplay.classList.add('ok');
                } else {
                    apiDisplay.textContent = 'Cargando...';
                }
            }
        }

        // ====== LANGUAGES ======
        function populateLanguages() {
            const sourceSet = new Set();
            const targetSet = new Set();
            
            allTariffs.forEach(t => {
                if (t.idiomaOrigen) sourceSet.add(t.idiomaOrigen);
                if (t.idiomaDestino) targetSet.add(t.idiomaDestino);
            });
            
            const sourceSelect = document.getElementById('sourceLang');
            const targetSelect = document.getElementById('targetLang');
            
            sourceSelect.innerHTML = '<option value="">Seleccionar...</option>';
            targetSelect.innerHTML = '<option value="">Seleccionar...</option>';
            
            [...sourceSet].sort().forEach(lang => {
                sourceSelect.innerHTML += `<option value="${lang}">${lang}</option>`;
            });
            
            [...targetSet].sort().forEach(lang => {
                targetSelect.innerHTML += `<option value="${lang}">${lang}</option>`;
            });
        }

        function onLanguageChange() {
            const src = document.getElementById('sourceLang').value;
            const tgt = document.getElementById('targetLang').value;
            
            budgetData.sourceLang = src;
            budgetData.targetLang = tgt;
            
            // Find tariff for this combination
            if (src && tgt) {
                const tariff = allTariffs.find(t => t.idiomaOrigen === src && t.idiomaDestino === tgt);
                if (tariff) {
                    budgetData.tariffPerWord = parseFloat(String(tariff.tarifaPorPalabra).replace(',', '.')) || 0;
                    budgetData.tariffPage1 = parseFloat(String(tariff.tarifaPagina1).replace(',', '.')) || 0;
                    budgetData.tariffPage2 = parseFloat(String(tariff.tarifaPagina2).replace(',', '.')) || 0;
                }
            }
            
            // Filter providers
            filterProviders();
            checkStep1Complete();
        }
        
        function onStep1Change() {
            // Capturar datos del cliente del paso 1
            const emailEl = document.getElementById('clientEmailStep1');
            const whatsappEl = document.getElementById('clientWhatsAppStep1');
            if (emailEl) budgetData.clientEmail = emailEl.value.trim();
            if (whatsappEl) budgetData.clientWhatsApp = whatsappEl.value.trim();
        }

        function filterProviders() {
            const src = document.getElementById('sourceLang').value;
            const tgt = document.getElementById('targetLang').value;
            
            if (!src || !tgt) {
                filteredProviders = [];
            } else {
                filteredProviders = allProviders.filter(p => 
                    p.idiomaOrigen === src && p.idiomaDestino === tgt
                );
            }
            
            selectedProviders.clear();
            renderProviders();
        }

        // ====== CHANNEL ======
        function selectChannel(channel) {
            document.querySelectorAll('.channel-btn').forEach(btn => {
                btn.classList.toggle('selected', btn.dataset.channel === channel);
            });
            budgetData.channel = channel;
            checkStep1Complete();
        }

        // ====== STEP NAVIGATION ======
        function checkStep1Complete() {
            const src = document.getElementById('sourceLang').value;
            const tgt = document.getElementById('targetLang').value;
            const channel = budgetData.channel;
            
            const complete = src && tgt && channel;
            document.getElementById('step1Btn').disabled = !complete;
        }

        function completeStep1() {
            completedSteps.add(1);
            updateProgressSteps();
            showCard(2);
        }

        function completeStep2() {
            if (uploadedFiles.length === 0) {
                showStatus('Adjunta al menos un archivo', 'warning');
                return;
            }
            completedSteps.add(2);
            updateProgressSteps();
            showCard(3);
            updateFolderPreview();
        }

        function completeStep4() {
            completedSteps.add(4);
            updateProgressSteps();
            showCard(5);
            
            // Auto-check include word count if we have data
            if (budgetData.wordCount) {
                document.getElementById('includeWordCount').classList.add('checked');
            }
        }

        function skipToStep(step) {
            showCard(step);
        }

        function goToStep(step) {
            const stepEl = document.querySelector(`.progress-step[data-step="${step}"]`);
            if (stepEl.classList.contains('locked')) return;
            showCard(step);
        }

        function showCard(step) {
            currentStep = step;
            
            // Hide all cards
            for (let i = 1; i <= 6; i++) {
                const card = document.getElementById(`step${i}Card`);
                if (card) card.classList.add('hidden');
            }
            
            // Show current card
            const currentCard = document.getElementById(`step${step}Card`);
            if (currentCard) currentCard.classList.remove('hidden');
            
            // Update progress steps visual
            document.querySelectorAll('.progress-step').forEach(el => {
                const s = parseInt(el.dataset.step);
                el.classList.remove('active');
                if (s === step) el.classList.add('active');
            });
            
            // Si es paso 4, mostrar tarifas por p√°gina
            if (step === 4) {
                updatePageTariffDisplay();
            }
            
            // Si es paso 6, pre-llenar email/whatsapp con datos del paso 1
            if (step === 6) {
                const clientEmail = document.getElementById('clientEmail');
                const clientWhatsApp = document.getElementById('clientWhatsApp');
                
                // Solo pre-llenar si est√°n vac√≠os
                if (clientEmail && !clientEmail.value && budgetData.clientEmail) {
                    clientEmail.value = budgetData.clientEmail;
                }
                if (clientWhatsApp && !clientWhatsApp.value && budgetData.clientWhatsApp) {
                    clientWhatsApp.value = budgetData.clientWhatsApp;
                }
                
                // Actualizar mensaje de cliente
                updateClientMessage();
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function updatePageTariffDisplay() {
            // Buscar tarifa por p√°gina para la combinaci√≥n actual
            const tariff = allTariffs.find(t => 
                t.idiomaOrigen === budgetData.sourceLang && 
                t.idiomaDestino === budgetData.targetLang
            );
            
            const langPair = document.getElementById('langPairDisplay');
            const page1 = document.getElementById('tariffPage1Display');
            const page2 = document.getElementById('tariffPage2Display');
            
            if (tariff) {
                langPair.textContent = `${budgetData.sourceLang} > ${budgetData.targetLang}`;
                page1.textContent = (tariff.tarifaPagina1 || 0).toFixed(2).replace('.', ',');
                page2.textContent = (tariff.tarifaPaginaResto || 0).toFixed(2).replace('.', ',');
                
                // Guardar en budgetData para c√°lculos
                budgetData.tariffPage1 = tariff.tarifaPagina1 || 0;
                budgetData.tariffPage2 = tariff.tarifaPaginaResto || 0;
                budgetData.tariffPerWord = tariff.tarifaPalabra || 0;
            } else {
                langPair.textContent = `${budgetData.sourceLang} > ${budgetData.targetLang}`;
                page1.textContent = '--';
                page2.textContent = '--';
            }
        }

        function updateProgressSteps() {
            document.querySelectorAll('.progress-step').forEach(el => {
                const step = parseInt(el.dataset.step);
                
                // First, remove all state classes
                el.classList.remove('completed', 'active', 'locked');
                
                // Then apply the correct state
                if (completedSteps.has(step)) {
                    el.classList.add('completed');
                } else if (step === currentStep) {
                    el.classList.add('active');
                } else if (step > currentStep && !completedSteps.has(step - 1)) {
                    el.classList.add('locked');
                }
                
                // Unlock step if previous is completed or current
                const maxCompleted = Math.max(...completedSteps, 0);
                if (step <= maxCompleted + 1) {
                    el.classList.remove('locked');
                }
            });
        }

        // ====== FILES ======
        function handleFiles(files) {
            for (const file of files) {
                if (uploadedFiles.some(f => f.name === file.name)) continue;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64 = e.target.result.split(',')[1];
                    uploadedFiles.push({
                        name: file.name,
                        size: file.size,
                        type: file.type || 'application/octet-stream',
                        content: base64
                    });
                    renderFiles();
                };
                reader.readAsDataURL(file);
            }
        }

        function renderFiles() {
            const list = document.getElementById('fileList');
            const total = document.getElementById('fileTotal');
            const area = document.getElementById('fileUploadArea');
            const btn = document.getElementById('step2Btn');
            
            if (uploadedFiles.length === 0) {
                list.innerHTML = '';
                total.style.display = 'none';
                area.classList.remove('has-files');
                btn.disabled = true;
                filesToCompress.clear();
                return;
            }
            
            area.classList.add('has-files');
            btn.disabled = false;
            
            let html = '';
            let totalSize = 0;
            const hasIlovepdf = ilovepdfPublicKey && ilovepdfSecretKey;
            
            uploadedFiles.forEach((f, i) => {
                totalSize += f.size;
                const isPdf = f.type === 'application/pdf' || f.name.toLowerCase().endsWith('.pdf');
                const isChecked = filesToCompress.has(i);
                const sizeClass = f.size > 2 * 1024 * 1024 ? 'file-size-large' : ''; // >2MB
                
                html += `
                    <div class="file-item">
                        <div class="file-item-info">
                            <span class="file-item-name">${f.name}</span>
                            <span class="file-item-size ${sizeClass}">${formatFileSize(f.size)}</span>
                        </div>
                        <div class="file-item-actions">
                            ${isPdf && hasIlovepdf ? `
                                <label class="compress-checkbox" title="Comprimir con iLovePDF">
                                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleCompress(${i})">
                                    <span class="compress-label">üì¶</span>
                                </label>
                            ` : ''}
                            <button class="file-item-remove" onclick="removeFile(${i})">‚úï</button>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
            
            // Mostrar contador de archivos a comprimir
            const compressCount = filesToCompress.size;
            let totalHtml = `<strong>${uploadedFiles.length}</strong> archivo(s) - <strong>${formatFileSize(totalSize)}</strong> total`;
            if (compressCount > 0) {
                totalHtml += ` | <span class="compress-count">üì¶ ${compressCount} a comprimir</span>`;
            }
            total.innerHTML = totalHtml;
            total.style.display = 'block';
        }
        
        function toggleCompress(index) {
            if (filesToCompress.has(index)) {
                filesToCompress.delete(index);
            } else {
                filesToCompress.add(index);
            }
            renderFiles();
        }

        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            filesToCompress.delete(index);
            // Reajustar √≠ndices en filesToCompress
            const newSet = new Set();
            filesToCompress.forEach(i => {
                if (i > index) newSet.add(i - 1);
                else if (i < index) newSet.add(i);
            });
            filesToCompress = newSet;
            renderFiles();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // ====== iLovePDF COMPRESSION ======
        async function compressFilesWithIlovepdf() {
            if (filesToCompress.size === 0) return;
            if (!ilovepdfPublicKey || !ilovepdfSecretKey) return;
            
            const indicesToCompress = Array.from(filesToCompress);
            let compressed = 0;
            
            for (const idx of indicesToCompress) {
                const file = uploadedFiles[idx];
                if (!file || !file.name.toLowerCase().endsWith('.pdf')) continue;
                
                try {
                    showStatus(`Comprimiendo ${file.name}... (${compressed + 1}/${indicesToCompress.length})`, 'loading');
                    
                    // 1. Autenticaci√≥n
                    const authResponse = await fetch('https://api.ilovepdf.com/v1/auth', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ public_key: ilovepdfPublicKey })
                    });
                    const authData = await authResponse.json();
                    if (!authData.token) throw new Error('Error de autenticaci√≥n iLovePDF');
                    
                    // 2. Iniciar tarea de compresi√≥n
                    const startResponse = await fetch('https://api.ilovepdf.com/v1/start/compress', {
                        method: 'GET',
                        headers: { 'Authorization': 'Bearer ' + authData.token }
                    });
                    const startData = await startResponse.json();
                    if (!startData.task) throw new Error('Error al iniciar tarea');
                    
                    // 3. Subir archivo
                    const formData = new FormData();
                    
                    // Convertir base64 a blob
                    const base64Data = file.content.split(',')[1];
                    const byteCharacters = atob(base64Data);
                    const byteArrays = [];
                    for (let offset = 0; offset < byteCharacters.length; offset += 512) {
                        const slice = byteCharacters.slice(offset, offset + 512);
                        const byteNumbers = new Array(slice.length);
                        for (let i = 0; i < slice.length; i++) {
                            byteNumbers[i] = slice.charCodeAt(i);
                        }
                        byteArrays.push(new Uint8Array(byteNumbers));
                    }
                    const blob = new Blob(byteArrays, { type: 'application/pdf' });
                    
                    formData.append('task', startData.task);
                    formData.append('file', blob, file.name);
                    
                    const uploadResponse = await fetch('https://api.ilovepdf.com/v1/upload', {
                        method: 'POST',
                        headers: { 'Authorization': 'Bearer ' + authData.token },
                        body: formData
                    });
                    const uploadData = await uploadResponse.json();
                    if (!uploadData.server_filename) throw new Error('Error al subir archivo');
                    
                    // 4. Procesar compresi√≥n
                    const processResponse = await fetch('https://api.ilovepdf.com/v1/process', {
                        method: 'POST',
                        headers: { 
                            'Authorization': 'Bearer ' + authData.token,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            task: startData.task,
                            tool: 'compress',
                            files: [{
                                server_filename: uploadData.server_filename,
                                filename: file.name
                            }],
                            compression_level: 'recommended'
                        })
                    });
                    const processData = await processResponse.json();
                    if (!processData.download_filename) throw new Error('Error al procesar');
                    
                    // 5. Descargar archivo comprimido
                    const downloadResponse = await fetch(`https://api.ilovepdf.com/v1/download/${startData.task}`, {
                        method: 'GET',
                        headers: { 'Authorization': 'Bearer ' + authData.token }
                    });
                    const compressedBlob = await downloadResponse.blob();
                    
                    // 6. Convertir a base64 y reemplazar en uploadedFiles
                    const reader = new FileReader();
                    const compressedBase64 = await new Promise((resolve) => {
                        reader.onload = () => resolve(reader.result);
                        reader.readAsDataURL(compressedBlob);
                    });
                    
                    const originalSize = file.size;
                    const newSize = compressedBlob.size;
                    const savings = Math.round((1 - newSize / originalSize) * 100);
                    
                    // Actualizar archivo en la lista
                    uploadedFiles[idx] = {
                        name: file.name,
                        type: 'application/pdf',
                        size: newSize,
                        content: compressedBase64
                    };
                    
                    console.log(`Comprimido ${file.name}: ${formatFileSize(originalSize)} ‚Üí ${formatFileSize(newSize)} (-${savings}%)`);
                    compressed++;
                    
                } catch (err) {
                    console.error('Error comprimiendo ' + file.name + ':', err);
                    showStatus(`Error comprimiendo ${file.name}: ${err.message}`, 'error');
                    await new Promise(r => setTimeout(r, 2000));
                }
            }
            
            // Limpiar marcas de compresi√≥n
            filesToCompress.clear();
            renderFiles();
            
            if (compressed > 0) {
                showStatus(`${compressed} archivo(s) comprimido(s) ‚úì`, 'success');
                await new Promise(r => setTimeout(r, 1500));
            }
        }

        // ====== FOLDER CREATION ======
        function updateFolderPreview() {
            const today = new Date();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            const preview = `${mm}${dd}-XX-${budgetData.channel}`;
            document.getElementById('previewBudgetId').textContent = preview;
        }

        async function createFolder() {
            const btn = document.getElementById('step3Btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Creando...';
            
            try {
                // Comprimir archivos marcados primero
                if (filesToCompress.size > 0) {
                    await compressFilesWithIlovepdf();
                }
                
                showStatus('Creando carpeta y subiendo archivos...', 'loading');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'createBudgetFolder',
                        channel: budgetData.channel,
                        sourceLang: budgetData.sourceLang,
                        targetLang: budgetData.targetLang,
                        clientEmail: budgetData.clientEmail,
                        clientWhatsApp: budgetData.clientWhatsApp,
                        files: uploadedFiles
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    budgetData.id = data.budgetId;
                    budgetData.folderId = data.folderId;
                    budgetData.folderUrl = data.folderUrl;
                    
                    // Update UI
                    document.getElementById('budgetIdDisplay').textContent = budgetData.id;
                    document.getElementById('budgetIdDisplay').classList.add('active');
                    document.getElementById('previewBudgetId').textContent = budgetData.id;
                    
                    // Show folder link
                    const folderLink = document.getElementById('folderLink');
                    folderLink.href = budgetData.folderUrl;
                    folderLink.classList.remove('hidden');
                    
                    completedSteps.add(3);
                    updateProgressSteps();
                    
                    hideStatus();  // Ocultar mensaje de carga
                    showSuccess('Carpeta creada', budgetData.id);
                    
                    setTimeout(() => {
                        hideSuccess();
                        showCard(4);
                    }, 1500);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = 'üìÅ Crear Carpeta en Drive';
        }

        // ====== WORD COUNT ======
        async function countPagesOnly() {
            if (!budgetData.folderId) {
                showStatus('Primero crea la carpeta del presupuesto', 'warning');
                return;
            }
            
            const btn = document.getElementById('countPagesBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Contando...';
            
            try {
                showStatus('Contando p√°ginas...', 'loading');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'countPagesOnly',
                        folderId: budgetData.folderId,
                        budgetId: budgetData.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    budgetData.fileAnalysis = data.analysis || [];
                    budgetData.wordCount = null;  // No contamos palabras
                    budgetData.pageCount = data.totalPages || 0;
                    
                    // Display results (sin palabras)
                    displayPageCountResults(data);
                    hideStatus();
                    
                    updateTotalPrice();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = 'üìÑ Solo P√°ginas <span class="btn-hint">(instant√°neo)</span>';
        }
        
        function displayPageCountResults(data) {
            const tbody = document.getElementById('wordCountBody');
            let html = '';
            
            data.analysis.forEach(file => {
                html += `
                    <tr>
                        <td>${file.fileName}</td>
                        <td style="text-align:right; color: var(--text-secondary);">--</td>
                        <td style="text-align:right; font-weight: 600;">${file.pages}</td>
                    </tr>
                `;
            });
            
            // Totals
            html += `
                <tr class="total-row">
                    <td><strong>TOTAL</strong></td>
                    <td style="text-align:right; color: var(--text-secondary);">--</td>
                    <td style="text-align:right;"><strong>${data.totalPages}</strong></td>
                </tr>
            `;
            
            tbody.innerHTML = html;
            
            // Ocultar secci√≥n de palabras, mostrar solo p√°ginas
            document.getElementById('tariffEditorWords').style.display = 'none';
            document.getElementById('resultByWords').style.display = 'none';
            
            document.getElementById('wordCountResults').classList.remove('hidden');
        }
        
        async function countWords() {
            if (!budgetData.folderId) {
                showStatus('Primero crea la carpeta del presupuesto', 'warning');
                return;
            }
            
            const btn = document.getElementById('countWordsBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Analizando...';
            
            try {
                showStatus('Analizando documentos (puede tardar unos segundos)...', 'loading');
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'countWords',
                        folderId: budgetData.folderId,
                        budgetId: budgetData.id
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    budgetData.fileAnalysis = data.analysis || [];
                    budgetData.wordCount = data.totalWords || 0;
                    budgetData.pageCount = data.totalPages || 0;
                    
                    // Display results
                    displayWordCountResults(data);
                    hideStatus();
                    
                    // Set custom tariff from config
                    document.getElementById('customTariff').value = budgetData.tariffPerWord.toFixed(2);
                    updateTotalPrice();
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
            }
            
            btn.disabled = false;
            btn.innerHTML = 'üî¢ Contar Palabras';
        }

        function displayWordCountResults(data) {
            const resultsBox = document.getElementById('wordCountResults');
            const tbody = document.getElementById('wordCountBody');
            
            let html = '';
            data.analysis.forEach(file => {
                html += `
                    <tr>
                        <td>${file.name}</td>
                        <td class="number">${file.words.toLocaleString('es-ES')}</td>
                        <td class="number">${file.pages}</td>
                    </tr>
                `;
            });
            
            html += `
                <tr class="total">
                    <td>TOTAL</td>
                    <td class="number">${data.totalWords.toLocaleString('es-ES')}</td>
                    <td class="number">${data.totalPages}</td>
                </tr>
            `;
            
            tbody.innerHTML = html;
            
            // Restaurar elementos que podr√≠an estar ocultos
            document.getElementById('tariffEditorWords').style.display = '';
            document.getElementById('resultByWords').style.display = '';
            
            resultsBox.classList.remove('hidden');
        }

        function updateTotalPrice() {
            const tariff = parseFloat(document.getElementById('customTariff').value) || 0;
            const words = budgetData.wordCount || 0;
            const pages = budgetData.pageCount || 0;
            
            // Price by words
            const priceByWords = (words * tariff).toFixed(2).replace('.', ',');
            document.getElementById('priceByWords').textContent = priceByWords + ' ‚Ç¨';
            
            // Price by pages
            const page1 = budgetData.tariffPage1 || 0;
            const page2 = budgetData.tariffPage2 || 0;
            let priceByPages = 0;
            if (pages > 0) {
                priceByPages = page1 + Math.max(0, pages - 1) * page2;
            }
            document.getElementById('priceByPages').textContent = priceByPages.toFixed(2).replace('.', ',') + ' ‚Ç¨';
        }

        // ====== PROVIDERS ======
        function renderProviders() {
            const list = document.getElementById('providersList');
            
            if (filteredProviders.length === 0) {
                list.innerHTML = `
                    <div class="no-providers">
                        <div>No hay proveedores para esta combinaci√≥n</div>
                    </div>
                `;
                updateSelectedCount();
                return;
            }
            
            let html = '';
            filteredProviders.forEach((p, i) => {
                const selected = selectedProviders.has(i) ? 'selected' : '';
                html += `
                    <div class="provider-item ${selected}" onclick="toggleProvider(${i})">
                        <div class="provider-checkbox"></div>
                        <div class="provider-info">
                            <div class="provider-name">${p.nombre}</div>
                            <div class="provider-email">${p.email}</div>
                        </div>
                    </div>
                `;
            });
            
            list.innerHTML = html;
            updateSelectedCount();
        }

        function toggleProvider(index) {
            if (selectedProviders.has(index)) {
                selectedProviders.delete(index);
            } else {
                selectedProviders.add(index);
            }
            renderProviders();
        }

        function toggleSelectAll() {
            if (selectedProviders.size === filteredProviders.length) {
                selectedProviders.clear();
            } else {
                filteredProviders.forEach((_, i) => selectedProviders.add(i));
            }
            renderProviders();
        }

        function updateSelectedCount() {
            document.getElementById('selectedCount').textContent = selectedProviders.size + ' seleccionados';
            document.getElementById('sendQuoteBtn').disabled = selectedProviders.size === 0;
        }

        // ====== DEADLINE ======
        function setDeadlineType(type) {
            deadlineType = type;
            document.getElementById('deadlineOpen').classList.toggle('active', type === 'open');
            document.getElementById('deadlineFixed').classList.toggle('active', type === 'fixed');
            document.getElementById('deadlineFields').classList.toggle('visible', type === 'fixed');
        }

        // ====== CHECKBOXES ======
        function toggleCheckbox(id) {
            document.getElementById(id).classList.toggle('checked');
        }

        function toggleProposedRateFields() {
            const isChecked = document.getElementById('includeProposedRate').classList.contains('checked');
            const fields = document.getElementById('proposedRateFields');
            
            if (isChecked) {
                fields.classList.remove('hidden');
                // Auto-fill with tariff and calculated total
                const tariff = budgetData.tariffPerWord || 0;
                const words = budgetData.wordCount || 0;
                document.getElementById('proposedTariff').value = tariff.toFixed(2);
                document.getElementById('proposedTotal').value = (tariff * words).toFixed(2);
            } else {
                fields.classList.add('hidden');
            }
        }

        function updateProposedTotal() {
            const tariff = parseFloat(document.getElementById('proposedTariff').value) || 0;
            const words = budgetData.wordCount || 0;
            document.getElementById('proposedTotal').value = (tariff * words).toFixed(2);
        }

        // ====== PROVIDER EMAIL ======
        function previewProviderEmail() {
            if (selectedProviders.size === 0) return;
            
            const providers = Array.from(selectedProviders).map(i => filteredProviders[i]);
            const includeWords = document.getElementById('includeWordCount').classList.contains('checked');
            const includeProposedRate = document.getElementById('includeProposedRate').classList.contains('checked');
            
            // Generar info de destinatarios
            let recipientsHtml = `
                <div><strong>Asunto:</strong> Nueva Tasaci√≥n Traducci√≥n Jurada ${budgetData.sourceLang} > ${budgetData.targetLang} [${budgetData.id}]</div>
                <div style="margin-top: 8px;"><strong>Destinatarios (${providers.length}):</strong> ${providers.map(p => p.nombre).join(', ')}</div>
            `;
            
            if (uploadedFiles.length > 0) {
                recipientsHtml += `<div style="margin-top: 8px; color: #1e8449;"><strong>üìé Adjuntos:</strong> ${uploadedFiles.length} archivo(s)</div>`;
            }
            
            document.getElementById('previewRecipients').innerHTML = recipientsHtml;
            
            // Generar mensaje editable
            const messageBody = generateProviderEmailBody(providers[0], includeWords, includeProposedRate);
            document.getElementById('providerMessageEdit').value = messageBody;
            
            document.getElementById('providerPreviewModal').classList.add('visible');
        }

        function generateProviderEmailBody(provider, includeWords, includeProposedRate) {
            let body = `Hola [NOMBRE],\n\n`;
            body += `Te escribo para solicitar tarifa y disponibilidad para una traducci√≥n.\n\n`;
            body += `DETALLES DEL ENCARGO\n`;
            body += `--------------------\n`;
            body += `* Combinaci√≥n: ${budgetData.sourceLang} > ${budgetData.targetLang}\n`;
            
            if (includeWords && budgetData.wordCount) {
                body += `* Palabras: ${budgetData.wordCount.toLocaleString('es-ES')}\n`;
                body += `* P√°ginas: ${budgetData.pageCount}\n`;
            }
            
            if (deadlineType === 'open') {
                body += `* Plazo: Abierto (ind√≠came tu mejor plazo)\n`;
            } else {
                const date = document.getElementById('deadlineDate').value;
                const time = document.getElementById('deadlineTime').value || '18:00';
                if (date) {
                    const dateObj = new Date(date);
                    const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
                    body += `* Plazo requerido: ${dateObj.toLocaleDateString('es-ES', options)} a las ${time}\n`;
                }
            }
            
            if (includeProposedRate) {
                const proposedTariff = parseFloat(document.getElementById('proposedTariff').value) || 0;
                const proposedTotal = parseFloat(document.getElementById('proposedTotal').value) || 0;
                if (proposedTariff > 0) {
                    body += `\n* Tarifa propuesta: ${proposedTariff.toFixed(2).replace('.', ',')} EUR/palabra\n`;
                }
                if (proposedTotal > 0) {
                    body += `* Total propuesto: ${proposedTotal.toFixed(2).replace('.', ',')} EUR\n`;
                }
            }
            
            const comments = document.getElementById('providerComments').value.trim();
            if (comments) {
                body += `\nCOMENTARIOS\n`;
                body += `--------------------\n`;
                body += `${comments}\n`;
            }
            
            body += `\n--------------------\n`;
            body += `Referencia: ${budgetData.id}\n\n`;
            body += `Por favor, conf√≠rmame disponibilidad y tarifa.\n\n`;
            body += `Gracias,\n\n`;
            body += `Javier Pardo Furness\n`;
            body += `Traductor Jurado N¬∫ 2098\n`;
            body += `Coordinador en Tradutema.com\n`;
            body += `info@tradutema.com\n`;
            body += `+34 670 91 78 60\n\n`;
            body += `Miembro de las Asociaciones de Traductores Profesionales: APTIJ, ASETRAD e IAPTI`;
            
            return body;
        }

        function closeProviderModal() {
            document.getElementById('providerPreviewModal').classList.remove('visible');
        }

        async function sendProviderEmails() {
            closeProviderModal();
            
            const providers = Array.from(selectedProviders).map(i => filteredProviders[i]);
            const customMessage = document.getElementById('providerMessageEdit').value;
            
            showStatus('Enviando emails a proveedores...', 'loading');
            
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'sendProviderEmails',
                        providers: providers,
                        budgetId: budgetData.id,
                        folderId: budgetData.folderId,
                        sourceLang: budgetData.sourceLang,
                        targetLang: budgetData.targetLang,
                        customMessage: customMessage  // Mensaje editado por el usuario
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    hideStatus();
                    const ok = data.results.filter(r => r.success).length;
                    
                    // Guardar traductores contactados
                    budgetData.contactedProviders = providers.map(p => ({
                        nombre: p.nombre,
                        email: p.email
                    }));
                    
                    // Mostrar secci√≥n de traductores contactados
                    renderContactedProviders();
                    document.getElementById('contactedProvidersSection').classList.remove('hidden');
                    
                    showSuccess('Emails enviados', `${ok} proveedor${ok > 1 ? 'es' : ''} notificado${ok > 1 ? 's' : ''}`);
                    
                    completedSteps.add(5);
                    updateProgressSteps();
                    
                    setTimeout(() => {
                        hideSuccess();
                        // No ir autom√°ticamente a paso 6, quedarse para elegir traductor
                    }, 2000);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
                setTimeout(hideStatus, 3000);
            }
        }
        
        // Renderizar traductores contactados con radio buttons
        function renderContactedProviders() {
            const container = document.getElementById('contactedProvidersList');
            if (!budgetData.contactedProviders || budgetData.contactedProviders.length === 0) {
                container.innerHTML = '<div class="no-providers">No se han contactado traductores</div>';
                return;
            }
            
            let html = '';
            budgetData.contactedProviders.forEach((p, idx) => {
                const isChosen = budgetData.chosenProvider === p.nombre;
                html += `
                    <div class="contacted-item ${isChosen ? 'chosen' : ''}" onclick="chooseProvider(${idx})">
                        <div class="contacted-radio"></div>
                        <div class="contacted-info">
                            <div class="contacted-name">${p.nombre}${isChosen ? '<span class="contacted-badge">ELEGIDO</span>' : ''}</div>
                            <div class="contacted-email">${p.email}</div>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }
        
        // Elegir traductor para el presupuesto
        async function chooseProvider(idx) {
            const provider = budgetData.contactedProviders[idx];
            budgetData.chosenProvider = provider.nombre;
            
            // Actualizar UI
            renderContactedProviders();
            
            // Guardar en backend
            try {
                await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveChosenProvider',
                        budgetId: budgetData.id,
                        chosenProvider: provider.nombre
                    })
                });
                showStatus('‚úì Traductor elegido: ' + provider.nombre, 'success');
                setTimeout(hideStatus, 2000);
            } catch (error) {
                console.log('Error guardando traductor elegido:', error);
            }
        }

        // ====== CLIENT MESSAGE ======
        function setMessageLang(lang) {
            messageLang = lang;
            document.querySelectorAll('.lang-toggle button').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.toLowerCase().includes(lang === 'es' ? 'espa√±ol' : 'english'));
            });
            updateClientMessage();
        }

        function onClientMessageEdit() {
            clientMessageEdited = true;
        }
        
        function updateClientMessage() {
            // Si el usuario ya edit√≥ el mensaje, no sobrescribir
            if (clientMessageEdited) return;
            
            const amount = document.getElementById('quoteAmount').value || 'XXX';
            const days = document.getElementById('quoteDays').value || 'X';
            const urgency = document.getElementById('quoteUrgency').value || '';
            const refId = budgetData.id || 'REFERENCIA';
            const srcLang = budgetData.sourceLang || 'origen';
            const tgtLang = budgetData.targetLang || 'destino';
            const numDocs = uploadedFiles.length || 1;
            
            // Document text
            const docText = numDocs > 1 ? `de los ${numDocs} documentos enviados` : 'del documento enviado';
            
            // Calculate delivery date
            let deliveryDate = 'X d√≠as laborables desde hoy';
            if (days && !isNaN(parseInt(days))) {
                const d = new Date();
                let added = 0;
                while (added < parseInt(days)) {
                    d.setDate(d.getDate() + 1);
                    if (d.getDay() !== 0 && d.getDay() !== 6) added++;
                }
                deliveryDate = d.toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' });
            }
            
            let message;
            
            if (messageLang === 'es') {
                message = `Hola,

La tarifa para la traducci√≥n jurada de ${srcLang} a ${tgtLang} ${docText} es de ${amount} EUR (IVA incluido).

Plazo aproximado: ${days} d√≠as laborables${urgency ? ` (si lo necesitas antes, es posible, con un recargo por urgencia de ${urgency} EUR)` : ''}.

Para realizar el pedido:
1. Haz clic en https://tradutema.com/cotizacion-personalizada/
2. Selecciona los idiomas. En Referencia Cotizaci√≥n, introduce ${refId}. En Importe indica ${amount} EUR, indica C√≥mo quieres recibir la traducci√≥n, en plazo indica la fecha de ${deliveryDate} y Carga los documentos.
3. Carrito situado arriba a la derecha de la p√°gina.
4. Haz clic en A√ëADIR AL CARRITO y ve al carrito para finalizar la compra.

Muchas gracias,

Javier Pardo Furness
Traductor Jurado N¬∫ 2098
Coordinador en Tradutema.com
info@tradutema.com
+34 670 91 78 60

Miembro de las Asociaciones de Traductores Profesionales: APTIJ, ASETRAD e IAPTI`;
            } else {
                const docTextEn = numDocs > 1 ? `of the ${numDocs} documents sent` : 'of the document sent';
                message = `Hello,

The fee for the sworn translation from ${srcLang} to ${tgtLang} ${docTextEn} is ${amount} EUR (VAT included).

Estimated delivery: ${days} working days${urgency ? ` (if you need it sooner, it's possible with an urgency surcharge of ${urgency} EUR)` : ''}.

To place your order:
1. Click on https://tradutema.com/cotizacion-personalizada/
2. Select the languages. In Quote Reference, enter ${refId}. In Amount enter ${amount} EUR, indicate how you want to receive the translation, in deadline enter the date ${deliveryDate} and upload the documents.
3. Shopping cart located at the top right of the page.
4. Click ADD TO CART and go to cart to complete your purchase.

Thank you very much,

Javier Pardo Furness
Sworn Translator No. 2098
Coordinator at Tradutema.com
info@tradutema.com
+34 670 91 78 60

Member of Professional Translator Associations: APTIJ, ASETRAD and IAPTI`;
            }
            
            document.getElementById('clientMessageEdit').value = message;
        }
        
        function regenerateClientMessage() {
            clientMessageEdited = false;
            updateClientMessage();
        }

        function validateClientFields() {
            const amount = document.getElementById('quoteAmount').value;
            const days = document.getElementById('quoteDays').value;
            
            if (!amount) {
                showStatus('Introduce el importe del presupuesto', 'warning');
                setTimeout(hideStatus, 3000);
                return false;
            }
            if (!days) {
                showStatus('Introduce el plazo en d√≠as laborables', 'warning');
                setTimeout(hideStatus, 3000);
                return false;
            }
            return true;
        }

        // Guardar datos del cliente en la hoja (sin enviar email)
        async function saveClientData() {
            const email = document.getElementById('clientEmail').value.trim();
            const whatsapp = document.getElementById('clientWhatsApp').value.trim();
            const amount = document.getElementById('quoteAmount').value;
            
            if (!budgetData.id) return;
            
            try {
                await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'saveClientData',
                        budgetId: budgetData.id,
                        clientEmail: email,
                        clientWhatsApp: whatsapp,
                        amount: amount
                    })
                });
            } catch (error) {
                console.log('Error guardando datos cliente:', error);
            }
        }

        async function copyForWhatsApp() {
            if (!validateClientFields()) return;
            
            const message = document.getElementById('clientMessageEdit').value;
            navigator.clipboard.writeText(message).then(async () => {
                showStatus('Copiado para WhatsApp ‚úì', 'success');
                // Guardar datos del cliente
                await saveClientData();
                completedSteps.add(6);
                updateProgressSteps();
                setTimeout(hideStatus, 2000);
            });
        }

        async function copyForEmail() {
            if (!validateClientFields()) return;
            
            const message = document.getElementById('clientMessageEdit').value;
            navigator.clipboard.writeText(message).then(async () => {
                showStatus('Copiado para Email ‚úì', 'success');
                // Guardar datos del cliente
                await saveClientData();
                completedSteps.add(6);
                updateProgressSteps();
                setTimeout(hideStatus, 2000);
            });
        }

        async function sendClientEmail() {
            const email = document.getElementById('clientEmail').value.trim();
            const whatsapp = document.getElementById('clientWhatsApp').value.trim();
            
            if (!email) {
                showStatus('Introduce el email del cliente', 'warning');
                setTimeout(hideStatus, 3000);
                return;
            }
            
            if (!validateClientFields()) return;
            
            const btn = document.getElementById('sendClientBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Enviando...';
            
            try {
                showStatus('Enviando presupuesto al cliente...', 'loading');
                
                const customMessage = document.getElementById('clientMessageEdit').value;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: 'sendClientEmail',
                        clientEmail: email,
                        clientWhatsApp: whatsapp,
                        budgetId: budgetData.id,
                        amount: document.getElementById('quoteAmount').value,
                        sourceLang: budgetData.sourceLang,
                        targetLang: budgetData.targetLang,
                        customMessage: customMessage  // Mensaje editado por el usuario
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    hideStatus();
                    completedSteps.add(6);
                    updateProgressSteps();
                    showSuccess('¬°Presupuesto enviado!', `Email enviado a ${email}`, true);
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                showStatus('Error: ' + error.message, 'error');
                setTimeout(hideStatus, 3000);
            }
            
            btn.disabled = false;
            btn.innerHTML = '‚úâÔ∏è Enviar Email al Cliente';
        }

        // ====== STATUS & SUCCESS ======
        function showStatus(msg, type) {
            const el = document.getElementById('statusMessage');
            el.className = 'status-message visible ' + type;
            el.innerHTML = type === 'loading' ? '<span class="spinner dark"></span> ' + msg : msg;
        }

        function hideStatus() {
            document.getElementById('statusMessage').classList.remove('visible');
        }

        function showSuccess(title, subtitle, returnToHome = false) {
            document.getElementById('successText').textContent = title;
            document.getElementById('successSubtext').textContent = subtitle;
            document.getElementById('successOverlay').classList.add('visible');
            
            // Auto-hide after 2.5 seconds
            setTimeout(() => {
                hideSuccess();
                if (returnToHome) {
                    showHomeScreen();
                }
            }, 2500);
        }

        function hideSuccess() {
            document.getElementById('successOverlay').classList.remove('visible');
        }
    </script>
</body>
</html>
