/**
 * TRADUTEMA - API GESTOR DE PRESUPUESTOS
 * Versión: 2.0
 * Fecha: 26/12/2025
 * 
 * Funcionalidades:
 * - Lectura de proveedores y tarifas
 * - Creación de carpetas de presupuesto en Drive
 * - Conteo de palabras (DOCX, PDF con texto)
 * - Envío de emails a proveedores
 * - Envío de presupuesto a clientes
 */

// ============ CONFIGURACIÓN ============
const CONFIG = {
  SPREADSHEET_ID: '1E75kTMGy4WSQbs04U4rkGKmPoR-B26hqX9S1Po1kX5w',
  BUDGETS_FOLDER_ID: '1DvREpebkLJlkxQ8UBI3i_XCZCHFGJtjD',
  SENDER_NAME: 'Tradutema',
  API_VERSION: '2.0'
};

// ============ AUTORIZACIÓN ============
function autorizarPermisos() {
  // Spreadsheet
  const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
  Logger.log('OK Hoja: ' + ss.getName());
  
  // Gmail
  GmailApp.getAliases();
  Logger.log('OK Gmail');
  
  // Drive
  const folder = DriveApp.getFolderById(CONFIG.BUDGETS_FOLDER_ID);
  Logger.log('OK Drive: ' + folder.getName());
  
  // Docs (for word count)
  const testDoc = DocumentApp.create('Test Permisos');
  DriveApp.getFileById(testDoc.getId()).setTrashed(true);
  Logger.log('OK Docs');
  
  Logger.log('=== TODOS LOS PERMISOS AUTORIZADOS ===');
}

// ============ doGet - Cargar datos ============
function doGet(e) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    
    // Cargar proveedores (pestaña Traductores)
    const providersSheet = ss.getSheetByName('Traductores');
    const providersData = providersSheet.getDataRange().getValues();
    const providers = [];
    
    for (let i = 1; i < providersData.length; i++) {
      if (providersData[i][0]) {
        providers.push({
          nombre: providersData[i][0],
          idiomaOrigen: providersData[i][1],
          idiomaDestino: providersData[i][2],
          email: providersData[i][3]
        });
      }
    }
    
    // Cargar tarifas (pestaña Tarifas)
    const tariffsSheet = ss.getSheetByName('Tarifas');
    const tariffsData = tariffsSheet.getDataRange().getValues();
    const tariffs = [];
    
    for (let i = 1; i < tariffsData.length; i++) {
      if (tariffsData[i][0]) {
        tariffs.push({
          idiomaOrigen: tariffsData[i][0],
          idiomaDestino: tariffsData[i][1],
          tarifaPagina1: tariffsData[i][2],
          tarifaPagina2: tariffsData[i][3],
          tarifaPorPalabra: tariffsData[i][4]
        });
      }
    }
    
    return jsonResponse({
      success: true,
      providers: providers,
      tariffs: tariffs,
      version: CONFIG.API_VERSION
    });
    
  } catch (error) {
    return jsonResponse({ success: false, error: error.message });
  }
}

// ============ doPost - Acciones ============
function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    switch (data.action) {
      case 'createBudgetFolder':
        return createBudgetFolder(data);
      
      case 'countWords':
        return countWords(data);
      
      case 'sendProviderEmails':
        return sendProviderEmails(data);
      
      case 'sendClientEmail':
        return sendClientEmail(data);
      
      default:
        return jsonResponse({ success: false, error: 'Acción no reconocida: ' + data.action });
    }
    
  } catch (error) {
    Logger.log('Error en doPost: ' + error.message);
    return jsonResponse({ success: false, error: error.message });
  }
}

// ============ CREAR CARPETA DE PRESUPUESTO ============
function createBudgetFolder(data) {
  try {
    const parentFolder = DriveApp.getFolderById(CONFIG.BUDGETS_FOLDER_ID);
    
    // Generar ID del presupuesto: MMDD-XX-Y
    const today = new Date();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    const datePrefix = mm + dd;
    
    // Contar presupuestos del día
    const folders = parentFolder.getFolders();
    let countToday = 0;
    
    while (folders.hasNext()) {
      const folder = folders.next();
      const name = folder.getName();
      if (name.startsWith(datePrefix + '-')) {
        countToday++;
      }
    }
    
    const orderNum = String(countToday + 1).padStart(2, '0');
    const budgetId = `${datePrefix}-${orderNum}-${data.channel}`;
    
    // Crear carpeta
    const newFolder = parentFolder.createFolder(budgetId);
    const folderId = newFolder.getId();
    const folderUrl = newFolder.getUrl();
    
    Logger.log('Carpeta creada: ' + budgetId);
    
    // Subir archivos
    if (data.files && data.files.length > 0) {
      for (const file of data.files) {
        try {
          const decoded = Utilities.base64Decode(file.content);
          const blob = Utilities.newBlob(decoded, file.type, file.name);
          newFolder.createFile(blob);
          Logger.log('Archivo subido: ' + file.name);
        } catch (fileError) {
          Logger.log('Error subiendo archivo ' + file.name + ': ' + fileError.message);
        }
      }
    }
    
    // Registrar en hoja de presupuestos (crear si no existe)
    registerBudget(budgetId, data.sourceLang, data.targetLang, data.channel, folderId);
    
    return jsonResponse({
      success: true,
      budgetId: budgetId,
      folderId: folderId,
      folderUrl: folderUrl
    });
    
  } catch (error) {
    Logger.log('Error creando carpeta: ' + error.message);
    return jsonResponse({ success: false, error: error.message });
  }
}

// ============ REGISTRAR PRESUPUESTO EN HOJA ============
function registerBudget(budgetId, sourceLang, targetLang, channel, folderId) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    let sheet = ss.getSheetByName('Presupuestos');
    
    // Crear hoja si no existe
    if (!sheet) {
      sheet = ss.insertSheet('Presupuestos');
      sheet.appendRow(['ID', 'Fecha', 'Origen', 'Destino', 'Canal', 'FolderID', 'Palabras', 'Páginas', 'Importe', 'Estado']);
      sheet.getRange(1, 1, 1, 10).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
    }
    
    // Añadir registro
    sheet.appendRow([
      budgetId,
      new Date(),
      sourceLang,
      targetLang,
      channel,
      folderId,
      '', // Palabras (se rellena después)
      '', // Páginas
      '', // Importe
      'Pendiente'
    ]);
    
  } catch (error) {
    Logger.log('Error registrando presupuesto: ' + error.message);
  }
}

// ============ CONTAR PALABRAS ============
function countWords(data) {
  try {
    const folder = DriveApp.getFolderById(data.folderId);
    const files = folder.getFiles();
    
    const analysis = [];
    let totalWords = 0;
    let totalPages = 0;
    
    while (files.hasNext()) {
      const file = files.next();
      const fileName = file.getName();
      const mimeType = file.getMimeType();
      
      Logger.log('Analizando: ' + fileName + ' (' + mimeType + ')');
      
      let words = 0;
      let pages = 1;
      
      try {
        if (mimeType === 'application/pdf') {
          // Convertir PDF a Google Doc para extraer texto
          const result = convertAndCount(file);
          words = result.words;
          pages = result.pages;
          
        } else if (mimeType === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' ||
                   mimeType === 'application/msword') {
          // Convertir Word a Google Doc
          const result = convertAndCount(file);
          words = result.words;
          pages = result.pages;
          
        } else if (mimeType === 'application/vnd.google-apps.document') {
          // Ya es Google Doc
          const doc = DocumentApp.openById(file.getId());
          const text = doc.getBody().getText();
          words = countWordsInText(text);
          pages = Math.ceil(words / 250) || 1; // Estimación: 250 palabras por página
          
        } else if (mimeType.startsWith('image/')) {
          // Las imágenes no se pueden contar automáticamente
          words = 0;
          pages = 1;
          Logger.log('Imagen - no se puede contar automáticamente');
        }
        
      } catch (fileError) {
        Logger.log('Error procesando ' + fileName + ': ' + fileError.message);
        words = 0;
        pages = 1;
      }
      
      analysis.push({
        name: fileName,
        words: words,
        pages: pages
      });
      
      totalWords += words;
      totalPages += pages;
    }
    
    // Crear informe en Google Sheet dentro de la carpeta
    createWordCountReport(folder, data.budgetId, analysis, totalWords, totalPages);
    
    // Actualizar registro del presupuesto
    updateBudgetWordCount(data.budgetId, totalWords, totalPages);
    
    return jsonResponse({
      success: true,
      analysis: analysis,
      totalWords: totalWords,
      totalPages: totalPages
    });
    
  } catch (error) {
    Logger.log('Error contando palabras: ' + error.message);
    return jsonResponse({ success: false, error: error.message });
  }
}

// ============ CONVERTIR Y CONTAR ============
function convertAndCount(file) {
  try {
    // Crear copia temporal como Google Doc
    const blob = file.getBlob();
    const resource = {
      title: 'temp_' + file.getName(),
      mimeType: MimeType.GOOGLE_DOCS
    };
    
    const tempFile = Drive.Files.insert(resource, blob, { convert: true });
    const doc = DocumentApp.openById(tempFile.id);
    const text = doc.getBody().getText();
    
    const words = countWordsInText(text);
    const pages = Math.ceil(words / 250) || 1;
    
    // Eliminar archivo temporal
    DriveApp.getFileById(tempFile.id).setTrashed(true);
    
    return { words: words, pages: pages };
    
  } catch (error) {
    Logger.log('Error en convertAndCount: ' + error.message);
    return { words: 0, pages: 1 };
  }
}

// ============ CONTAR PALABRAS EN TEXTO ============
function countWordsInText(text) {
  if (!text || text.trim() === '') return 0;
  
  // Limpiar texto
  const cleaned = text
    .replace(/[\r\n]+/g, ' ')
    .replace(/[^\w\sáéíóúüñÁÉÍÓÚÜÑ]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  
  if (cleaned === '') return 0;
  
  return cleaned.split(' ').filter(w => w.length > 0).length;
}

// ============ CREAR INFORME DE RECUENTO ============
function createWordCountReport(folder, budgetId, analysis, totalWords, totalPages) {
  try {
    const ss = SpreadsheetApp.create('Análisis_' + budgetId);
    const sheet = ss.getActiveSheet();
    sheet.setName('Recuento');
    
    // Cabecera
    sheet.appendRow(['ANÁLISIS DE PALABRAS - ' + budgetId]);
    sheet.appendRow(['Fecha:', new Date().toLocaleString('es-ES')]);
    sheet.appendRow([]);
    sheet.appendRow(['Archivo', 'Palabras', 'Páginas']);
    
    // Estilo cabecera
    sheet.getRange(1, 1).setFontWeight('bold').setFontSize(14);
    sheet.getRange(4, 1, 1, 3).setFontWeight('bold').setBackground('#1e3a5f').setFontColor('white');
    
    // Datos
    analysis.forEach(file => {
      sheet.appendRow([file.name, file.words, file.pages]);
    });
    
    // Total
    const lastRow = sheet.getLastRow() + 1;
    sheet.appendRow(['TOTAL', totalWords, totalPages]);
    sheet.getRange(lastRow, 1, 1, 3).setFontWeight('bold').setBackground('#d4a853');
    
    // Ajustar columnas
    sheet.autoResizeColumns(1, 3);
    
    // Mover a la carpeta del presupuesto
    const file = DriveApp.getFileById(ss.getId());
    file.moveTo(folder);
    
    Logger.log('Informe creado: ' + ss.getName());
    
  } catch (error) {
    Logger.log('Error creando informe: ' + error.message);
  }
}

// ============ ACTUALIZAR RECUENTO EN PRESUPUESTO ============
function updateBudgetWordCount(budgetId, words, pages) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const sheet = ss.getSheetByName('Presupuestos');
    if (!sheet) return;
    
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === budgetId) {
        sheet.getRange(i + 1, 7).setValue(words); // Columna Palabras
        sheet.getRange(i + 1, 8).setValue(pages); // Columna Páginas
        break;
      }
    }
    
  } catch (error) {
    Logger.log('Error actualizando presupuesto: ' + error.message);
  }
}

// ============ ENVIAR EMAILS A PROVEEDORES ============
function sendProviderEmails(data) {
  try {
    const results = [];
    
    // Obtener archivos de la carpeta para adjuntar
    const attachments = [];
    if (data.folderId) {
      const folder = DriveApp.getFolderById(data.folderId);
      const files = folder.getFiles();
      
      while (files.hasNext()) {
        const file = files.next();
        // No adjuntar el informe de análisis
        if (!file.getName().startsWith('Análisis_')) {
          attachments.push(file.getBlob());
        }
      }
    }
    
    for (const provider of data.providers) {
      try {
        let body = `Hola ${provider.nombre},\n\n`;
        body += `Te escribo para solicitar tarifa y disponibilidad para una traducción.\n\n`;
        body += `DETALLES DEL ENCARGO\n`;
        body += `--------------------\n`;
        body += `* Combinación: ${data.sourceLang} > ${data.targetLang}\n`;
        
        if (data.wordCount) {
          body += `* Palabras: ${parseInt(data.wordCount).toLocaleString('es-ES')}\n`;
        }
        if (data.pageCount) {
          body += `* Páginas: ${data.pageCount}\n`;
        }
        
        if (data.deadline === 'open') {
          body += `* Plazo: Abierto (indícame tu mejor plazo)\n`;
        } else if (data.deadlineDate) {
          const dateObj = new Date(data.deadlineDate);
          const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
          const formattedDate = dateObj.toLocaleDateString('es-ES', options);
          const time = data.deadlineTime || '18:00';
          body += `* Plazo requerido: ${formattedDate} a las ${time}\n`;
        }
        
        if (data.includeRate && data.tariffPerWord > 0) {
          const rate = parseFloat(data.tariffPerWord).toFixed(2).replace('.', ',');
          body += `\n* Tarifa acordada: ${rate} EUR/palabra\n`;
        }
        
        if (data.comments && data.comments.trim()) {
          body += `\nCOMENTARIOS\n`;
          body += `--------------------\n`;
          body += `${data.comments}\n`;
        }
        
        body += `\n--------------------\n`;
        body += `Referencia: ${data.budgetId}\n\n`;
        body += `Por favor, confírmame disponibilidad y tarifa.\n\n`;
        body += `Gracias,\n${CONFIG.SENDER_NAME}`;
        
        const subject = `Solicitud de tarifa - ${data.sourceLang} > ${data.targetLang} [${data.budgetId}]`;
        
        const emailOptions = { name: CONFIG.SENDER_NAME };
        if (attachments.length > 0) {
          emailOptions.attachments = attachments;
        }
        
        GmailApp.sendEmail(provider.email, subject, body, emailOptions);
        
        Logger.log('Email enviado a: ' + provider.email);
        results.push({ provider: provider.nombre, email: provider.email, success: true });
        
      } catch (err) {
        Logger.log('Error enviando a ' + provider.email + ': ' + err.message);
        results.push({ provider: provider.nombre, email: provider.email, success: false, error: err.message });
      }
    }
    
    return jsonResponse({
      success: true,
      results: results,
      attachmentsSent: attachments.length
    });
    
  } catch (error) {
    Logger.log('Error en sendProviderEmails: ' + error.message);
    return jsonResponse({ success: false, error: error.message });
  }
}

// ============ ENVIAR EMAIL A CLIENTE ============
function sendClientEmail(data) {
  try {
    let subject, body;
    
    const amount = data.amount || 'XXX';
    const days = data.days || 'X';
    const urgency = data.urgency || '';
    const refId = data.budgetId || 'REFERENCIA';
    
    // Calcular fecha de entrega
    let deliveryDate = '';
    if (days && !isNaN(parseInt(days))) {
      const d = new Date();
      let added = 0;
      while (added < parseInt(days)) {
        d.setDate(d.getDate() + 1);
        if (d.getDay() !== 0 && d.getDay() !== 6) added++;
      }
      deliveryDate = d.toLocaleDateString(data.language === 'es' ? 'es-ES' : 'en-GB', { 
        day: 'numeric', 
        month: 'long', 
        year: 'numeric' 
      });
    }
    
    if (data.language === 'es') {
      subject = `Presupuesto traducción jurada ${data.sourceLang} > ${data.targetLang} [${refId}]`;
      
      body = `Hola,\n\n`;
      body += `La tarifa para la traducción jurada del documento enviado es de ${amount} EUR (IVA incluido).\n\n`;
      body += `Plazo aproximado: ${days} días laborables`;
      if (urgency) {
        body += ` (si lo necesitas antes, es posible, con un recargo por urgencia de ${urgency} EUR)`;
      }
      body += `.\n\n`;
      body += `Para realizar el pedido:\n`;
      body += `1. Haz clic en https://tradutema.com/cotizacion-personalizada/\n`;
      body += `2. Selecciona los idiomas. En Referencia Cotización, introduce ${refId}. En Importe indica ${amount} EUR, indica Cómo quieres recibir la traducción, en plazo indica la fecha de ${deliveryDate} y Carga los documentos.\n`;
      body += `3. Carrito situado arriba a la derecha de la página.\n`;
      body += `4. Haz clic en AÑADIR AL CARRITO y ve al carrito para finalizar la compra.\n\n`;
      body += `Muchas gracias,\n\n`;
      body += `Javier Pardo Furness\n`;
      body += `Traductor Jurado Nº 2098\n`;
      body += `Coordinador en Tradutema.com\n`;
      body += `info@tradutema.com\n`;
      body += `+34 670 91 78 60\n\n`;
      body += `Miembro de las Asociaciones de Traductores Profesionales: APTIJ, ASETRAD e IAPTI`;
      
    } else {
      subject = `Quote for sworn translation ${data.sourceLang} > ${data.targetLang} [${refId}]`;
      
      body = `Hello,\n\n`;
      body += `The fee for the sworn translation of the document sent is ${amount} EUR (VAT included).\n\n`;
      body += `Estimated delivery: ${days} working days`;
      if (urgency) {
        body += ` (if you need it sooner, it's possible with an urgency surcharge of ${urgency} EUR)`;
      }
      body += `.\n\n`;
      body += `To place your order:\n`;
      body += `1. Click on https://tradutema.com/cotizacion-personalizada/\n`;
      body += `2. Select the languages. In Quote Reference, enter ${refId}. In Amount enter ${amount} EUR, indicate how you want to receive the translation, in deadline enter the date ${deliveryDate} and upload the documents.\n`;
      body += `3. Shopping cart located at the top right of the page.\n`;
      body += `4. Click ADD TO CART and go to cart to complete your purchase.\n\n`;
      body += `Thank you very much,\n\n`;
      body += `Javier Pardo Furness\n`;
      body += `Sworn Translator No. 2098\n`;
      body += `Coordinator at Tradutema.com\n`;
      body += `info@tradutema.com\n`;
      body += `+34 670 91 78 60\n\n`;
      body += `Member of Professional Translator Associations: APTIJ, ASETRAD and IAPTI`;
    }
    
    GmailApp.sendEmail(data.clientEmail, subject, body, { name: CONFIG.SENDER_NAME });
    
    // Actualizar estado del presupuesto
    updateBudgetStatus(data.budgetId, 'Enviado', amount);
    
    Logger.log('Email enviado al cliente: ' + data.clientEmail);
    
    return jsonResponse({ success: true });
    
  } catch (error) {
    Logger.log('Error enviando a cliente: ' + error.message);
    return jsonResponse({ success: false, error: error.message });
  }
}

// ============ ACTUALIZAR ESTADO PRESUPUESTO ============
function updateBudgetStatus(budgetId, status, amount) {
  try {
    const ss = SpreadsheetApp.openById(CONFIG.SPREADSHEET_ID);
    const sheet = ss.getSheetByName('Presupuestos');
    if (!sheet) return;
    
    const data = sheet.getDataRange().getValues();
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === budgetId) {
        if (amount) sheet.getRange(i + 1, 9).setValue(amount); // Columna Importe
        sheet.getRange(i + 1, 10).setValue(status); // Columna Estado
        break;
      }
    }
    
  } catch (error) {
    Logger.log('Error actualizando estado: ' + error.message);
  }
}

// ============ HELPER: JSON RESPONSE ============
function jsonResponse(obj) {
  return ContentService.createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}
